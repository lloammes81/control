<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Control de Bills (DB Local)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;700;800&display=swap');

    :root{
      --bg:#0b1220;--card:#111a2e;--muted:#a7b2cc;--text:#eef3ff;
      --line:rgba(255,255,255,.10);--accent:#4da3ff;--danger:#ff4d6d;--ok:#2ee59d;
      --shadow:0 10px 30px rgba(0,0,0,.35);--r:16px;
      --mono:'JetBrains Mono',ui-monospace,Menlo,Consolas,monospace;
      --sans:'Syne',system-ui,Segoe UI,Arial
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--text);background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:22px;font-weight:800}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06)}
    .chip label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{
      padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--text);outline:none;font-family:var(--sans)
    }
    button{cursor:pointer;transition:.12s ease}
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    button.primary{background:rgba(77,163,255,.22);border-color:rgba(77,163,255,.35)}
    button.danger{background:rgba(255,77,109,.18);border-color:rgba(255,77,109,.35)}
    button.ok{background:rgba(46,229,157,.16);border-color:rgba(46,229,157,.30)}
    button.warn{background:rgba(255,200,50,.16);border-color:rgba(255,200,50,.35);color:#ffc832}
    button.iconBtn{
      width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;line-height:1;padding:0;border-radius:12px;
    }
    .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .bd{padding:16px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:18px;margin-top:6px;font-family:var(--mono)}
    .kpi .sub{font-size:12px;margin-top:4px;color:rgba(238,243,255,.75)}
    form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:680px){form{grid-template-columns:1fr}}
    .row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:1040px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);position:sticky;top:0;background:rgba(17,26,46,.95)}
    .mono{font-family:var(--mono)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px}
    .pill.overdue{border-color:rgba(255,77,109,.55);background:rgba(255,77,109,.12)}
    .pill.soon{border-color:rgba(77,163,255,.55);background:rgba(77,163,255,.12)}
    .pill.ok{border-color:rgba(46,229,157,.55);background:rgba(46,229,157,.10)}
    .toast{position:fixed;right:16px;bottom:16px;background:rgba(17,26,46,.95);border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);display:none;max-width:560px;z-index:9999;font-family:var(--sans)}
    .toast.show{display:block}
    .banner{padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:14px;z-index:1000
    }
    .modal{
      width:min(980px,100%);max-height:88vh;overflow:auto;
      background:rgba(17,26,46,.98);border:1px solid var(--line);
      border-radius:18px;box-shadow:var(--shadow)
    }
    .modal.smallModal{width:min(560px,100%)}
    .modal .hd{position:sticky;top:0;background:rgba(17,26,46,.98);z-index:2}
    .modalBack.show{display:flex}

    /* ‚îÄ‚îÄ Supabase Config Modal ‚îÄ‚îÄ */
    .sbConfigSection{margin-bottom:20px}
    .sbConfigSection h3{margin:0 0 8px;font-size:14px;font-weight:700;color:var(--accent)}
    .sbField{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .sbField label{font-size:12px;color:var(--muted)}
    .sbField input{width:100%;font-family:var(--mono);font-size:12px;letter-spacing:.3px}
    .sbField input.hasValue{border-color:rgba(46,229,157,.4);background:rgba(46,229,157,.06)}
    .sbField input.empty{border-color:rgba(255,77,109,.35)}
    .connStatus{
      display:flex;align-items:center;gap:10px;padding:12px 16px;
      border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);
      font-size:13px;font-family:var(--mono)
    }
    .connStatus .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:.3s}
    .connStatus.checking .dot{background:#ffc832;animation:pulse 1s infinite}
    .connStatus.connected .dot{background:#2ee59d}
    .connStatus.error .dot{background:#ff4d6d}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .stepGuide{
      margin-top:16px;padding:14px;border-radius:12px;
      background:rgba(77,163,255,.06);border:1px solid rgba(77,163,255,.20)
    }
    .stepGuide h4{margin:0 0 10px;font-size:13px;color:var(--accent)}
    .stepGuide ol{margin:0;padding-left:18px}
    .stepGuide li{font-size:12px;color:var(--muted);margin-bottom:6px;line-height:1.6}
    .stepGuide code{
      background:rgba(77,163,255,.12);padding:2px 6px;border-radius:6px;
      font-family:var(--mono);font-size:11px;color:var(--accent)
    }
    .keyPreview{
      font-family:var(--mono);font-size:11px;color:var(--muted);
      background:rgba(0,0,0,.3);padding:6px 10px;border-radius:8px;
      border:1px solid var(--line);word-break:break-all;margin-top:6px;min-height:32px
    }
    .tagValid{color:#2ee59d;font-size:11px;font-family:var(--mono)}
    .tagInvalid{color:#ff4d6d;font-size:11px;font-family:var(--mono)}

    /* nav top */
    .topNav{
      display:flex;align-items:center;gap:0;margin-bottom:16px;
      border:1px solid var(--line);border-radius:14px;overflow:hidden;
      background:rgba(0,0,0,.2)
    }
    .topNav button{
      flex:1;border:none;border-radius:0;padding:11px 14px;font-size:13px;font-weight:600;
      background:transparent;color:var(--muted);transition:.15s;border-right:1px solid var(--line)
    }
    .topNav button:last-child{border-right:none}
    .topNav button:hover{background:rgba(255,255,255,.06);color:var(--text);transform:none}
    .topNav button.active{background:rgba(77,163,255,.15);color:var(--accent)}
    .tabPane{display:none}
    .tabPane.active{display:block}

    #dbConnStatus{
      position:fixed;top:8px;right:8px;
      background:#222;border:1px solid #555;padding:8px 14px;
      border-radius:12px;color:white;font-size:13px;z-index:9999;
      font-family:var(--mono)
    }
  </style>
</head>
<body>

<div id="dbConnStatus">Verificando conexi√≥n‚Ä¶</div>
<img src="logo.svg" width="80" alt="Bills Control Logo" style="border-radius:16px;display:none">

<div class="wrap">
  <header>
    <div>
      <h1>üí≥ Control de Bills</h1>
      <div class="muted">Pagos mensuales ¬∑ DB Local + Supabase</div>
    </div>
    <div class="toolbar">
      <button class="ok" id="btnInstallTips">C√≥mo instalar</button>
      <button class="ok" id="btnNotif">Activar notificaciones</button>
      <button class="ok" id="btnSchedule">Programar alertas</button>
      <div class="chip">
        <label for="filter">Filtro</label>
        <select id="filter">
          <option value="all">Todos</option>
          <option value="overdue">Vencidos</option>
          <option value="soon">Por vencer</option>
          <option value="ok">Al d√≠a</option>
        </select>
      </div>
      <div class="chip">
        <label for="dbMode">DB</label>
        <select id="dbMode">
          <option value="local">Local</option>
          <option value="supabase">Supabase</option>
        </select>
      </div>
      <button id="btnSync" title="Copia datos Local ‚Üí Supabase">Sync ‚Üí Supabase</button>
      <button id="btnBackup">Backup JSON</button>
      <button id="btnImport">Importar JSON</button>
      <button class="danger" id="btnReset">Borrar DB</button>
      <button class="warn" id="btnOpenSupaConfig" title="Configurar Supabase">‚öôÔ∏è Supabase</button>
      <input id="fileImport" type="file" accept="application/json" hidden>
    </div>
  </header>

  <!-- TAB NAV -->
  <nav class="topNav">
    <button class="active" data-tab="tabMain">üìä Dashboard</button>
    <button data-tab="tabForm">‚ûï Agregar / Editar</button>
    <button data-tab="tabPay">üí∏ Marcar Pagado</button>
  </nav>

  <!-- TAB: MAIN -->
  <div class="tabPane active" id="tabMain">
    <div class="card" style="margin-bottom:12px">
      <div class="hd">
        <div class="muted">Resumen</div>
        <div class="muted">Moneda: <span id="currencyLabel">USD</span></div>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total mensual</div>
            <div class="value" id="kTotalMonthly">$0.00</div>
            <div class="sub">Suma de montos</div>
          </div>
          <div class="kpi">
            <div class="label">Vencidos</div>
            <div class="value" id="kOverdue">0</div>
            <div class="sub" id="kOverdueSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Por vencer</div>
            <div class="value" id="kSoon">0</div>
            <div class="sub" id="kSoonSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Al d√≠a</div>
            <div class="value" id="kOk">0</div>
            <div class="sub">‚Äî</div>
          </div>
        </div>
        <div style="margin-top:12px" class="banner">
          <div class="muted" id="bannerText">‚Äî</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <span class="muted">Avisar con:</span>
            <select id="remindDays">
              <option value="0">0 d√≠as</option>
              <option value="1">1 d√≠a</option>
              <option value="3">3 d√≠as</option>
              <option value="5">5 d√≠as</option>
              <option value="7" selected>7 d√≠as</option>
              <option value="10">10 d√≠as</option>
              <option value="15">15 d√≠as</option>
            </select>
          </div>
        </div>
        <div class="small" style="margin-top:10px">
          Datos locales por dispositivo. Para moverlos: Backup JSON ‚Üí Importar en otro.
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="hd">
        <div class="muted">Bills</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="search" type="text" placeholder="Buscar (nombre, categor√≠a, proveedor)" style="min-width:280px">
          <button id="btnRefresh">Actualizar</button>
        </div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Estado</th><th>Bill</th><th>Vence</th>
                <th class="mono">Monto mensual</th><th>√öltimo pago</th>
                <th>Pr√≥ximo pago</th><th>M√©todo</th><th>Proveedor</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px">
          * Si tu navegador NO soporta "notificaci√≥n programada", avisa cuando la app est√° abierta.
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: FORM -->
  <div class="tabPane" id="tabForm">
    <div class="card">
      <div class="hd">
        <div class="muted">Agregar / Editar bill</div>
        <div class="muted">ID: <span id="editId">Nuevo</span></div>
      </div>
      <div class="bd">
        <form id="billForm">
          <div style="grid-column:1/-1">
            <div class="muted">Nombre del bill</div>
            <div class="row" style="margin-top:8px">
              <select id="billNameSelect" style="flex:1;min-width:260px" required></select>
              <button class="ok iconBtn" type="button" id="btnAddBillName" title="Agregar bill">+</button>
            </div>
            <div class="muted" style="margin-top:6px">Si no est√° en la lista, agr√©galo con "+".</div>
          </div>
          <div>
            <div class="muted">Monto mensual</div>
            <input id="amount" type="number" step="0.01" min="0" placeholder="Ej: 120.50" required>
          </div>
          <div>
            <div class="muted">D√≠a de vencimiento (cada mes)</div>
            <select id="dueDay" required></select>
            <div class="muted" style="margin-top:6px">* Si el mes no tiene ese d√≠a (31), se usa el √∫ltimo.</div>
          </div>
          <div>
            <div class="muted">M√©todo</div>
            <select id="method">
              <option>Cash</option><option>Card</option><option>Transfer</option>
              <option>Zelle</option><option>Check</option><option>AutoPay</option>
            </select>
            <div class="muted" style="margin-top:6px">Moneda</div>
            <select id="currency">
              <option value="USD">USD</option><option value="EUR">EUR</option>
              <option value="DOP">DOP</option><option value="MXN">MXN</option>
            </select>
          </div>
          <div class="row">
            <input id="category" type="text" placeholder="Categor√≠a (opcional): Utilities, Rent‚Ä¶" style="flex:1;min-width:240px" maxlength="40">
            <input id="vendor" type="text" placeholder="Proveedor (opcional): FPL, AT&T‚Ä¶" style="width:260px" maxlength="60">
          </div>
          <div class="row">
            <button class="primary" type="submit">Guardar bill</button>
            <button type="button" id="btnClear">Limpiar</button>
            <span class="muted" id="formHint">‚Äî</span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- TAB: PAY -->
  <div class="tabPane" id="tabPay">
    <div class="card">
      <div class="hd">
        <div class="muted">Marcar pagado</div>
        <div class="muted">Bill: <span id="payBillName">‚Äî</span></div>
      </div>
      <div class="bd">
        <div class="muted">Selecciona el bill y confirma el pago.</div>
        <div class="row" style="margin-top:10px">
          <div style="flex:1;min-width:260px">
            <div class="muted">Seleccionar bill</div>
            <select id="payBillSelect" style="width:100%"></select>
          </div>
          <button class="ok iconBtn" type="button" id="btnPayAddBill" title="Agregar bill">+</button>
          <button class="ok" type="button" id="btnPayLoad">Cargar</button>
        </div>
        <div style="margin-top:10px" class="row">
          <div style="flex:1;min-width:240px">
            <div class="muted">Fecha de pago</div>
            <input id="payDate" type="date">
          </div>
          <div style="width:240px">
            <div class="muted">Monto pagado</div>
            <input id="payAmount" type="number" step="0.01" min="0">
          </div>
        </div>
        <div style="margin-top:10px" class="row">
          <input id="payNote" type="text" placeholder="Nota (opcional)" style="flex:1;min-width:240px" maxlength="120">
          <button class="ok" id="btnConfirmPay" disabled>Confirmar pago</button>
        </div>
        <div class="muted" style="margin-top:10px">
          Al confirmar: guarda el pago en historial y calcula la pr√≥xima fecha (mes siguiente).
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: HISTORIAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="hd">
      <div>
        <div style="font-weight:700">Historial de pagos</div>
        <div class="small" id="histTitle">‚Äî</div>
      </div>
      <div class="actions">
        <button id="btnHistCSV">Exportar CSV</button>
        <button class="danger" id="btnHistClose">Cerrar</button>
      </div>
    </div>
    <div class="bd">
      <div class="row" style="justify-content:space-between">
        <div class="small">Total pagado: <span class="mono" id="histTotal">‚Äî</span></div>
        <div class="small">Pagos: <span class="mono" id="histCount">0</span></div>
      </div>
      <div style="margin-top:12px" class="tableWrap">
        <table style="min-width:860px">
          <thead>
            <tr><th>Fecha</th><th class="mono">Monto</th><th>Nota</th><th>Acci√≥n</th></tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: AGREGAR NOMBRE -->
<div class="modalBack" id="billNameModalBack">
  <div class="modal smallModal">
    <div class="hd">
      <div>
        <div style="font-weight:700">Agregar nombre de bill</div>
        <div class="small">Se agrega al combo para luego crear el bill completo.</div>
      </div>
      <div class="actions">
        <button class="danger" id="btnBillNameClose">Cerrar</button>
      </div>
    </div>
    <div class="bd">
      <div class="muted">Nombre</div>
      <input id="billNameNew" type="text" placeholder="Ej: Luz / Renta / Seguro‚Ä¶" style="width:100%;margin-top:8px" maxlength="60">
      <div class="row" style="margin-top:12px">
        <button class="ok" id="btnBillNameSave" type="button">Guardar</button>
        <span class="muted" id="billNameHint">‚Äî</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL: CONFIGURACI√ìN SUPABASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modalBack" id="supaConfigModal">
  <div class="modal smallModal">
    <div class="hd">
      <div>
        <div style="font-weight:800;font-size:16px">‚öôÔ∏è Configuraci√≥n Supabase</div>
        <div class="small">Conecta tu base de datos en la nube</div>
      </div>
      <div class="actions">
        <button class="danger" id="btnSupaConfigClose">‚úï Cerrar</button>
      </div>
    </div>

    <div class="bd">

      <!-- Estado de conexi√≥n -->
      <div class="connStatus checking" id="modalConnStatus">
        <div class="dot"></div>
        <span id="modalConnText">Verificando‚Ä¶</span>
      </div>

      <div style="margin-top:16px">

        <!-- URL -->
        <div class="sbField">
          <label>üîó Project URL</label>
          <input type="text" id="sbUrlInput" placeholder="https://xxxxxxxxxxxx.supabase.co" autocomplete="off">
          <div class="keyPreview" id="sbUrlPreview">‚Äî</div>
        </div>

        <!-- ANON KEY -->
        <div class="sbField">
          <label>üîë Anon Key <span id="anonKeyTag"></span></label>
          <input type="password" id="sbKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
          <div class="keyPreview" id="sbKeyPreview">‚Äî</div>
          <div style="margin-top:4px;font-size:11px;color:var(--muted)">
            La clave correcta empieza con <code style="font-family:var(--mono);color:var(--accent)">eyJ</code> y tiene ~200 caracteres.
          </div>
        </div>

        <!-- Acciones -->
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
          <button class="primary" id="btnSbSave">üíæ Guardar credenciales</button>
          <button class="ok" id="btnSbTest">üîå Probar conexi√≥n</button>
          <button class="danger" id="btnSbClear">üóë Borrar credenciales</button>
        </div>

        <!-- Resultado test -->
        <div id="sbTestResult" style="margin-top:12px;display:none;padding:12px;border-radius:10px;font-size:13px;font-family:var(--mono)"></div>

      </div>

      <!-- Gu√≠a paso a paso -->
      <div class="stepGuide">
        <h4>üìã ¬øC√≥mo obtener la Anon Key?</h4>
        <ol>
          <li>Ve a <code>supabase.com</code> ‚Üí inicia sesi√≥n</li>
          <li>Selecciona tu proyecto</li>
          <li>Men√∫ izquierdo ‚Üí <code>Settings</code> (engranaje) ‚Üí <code>API</code></li>
          <li>Secci√≥n <code>Project API Keys</code></li>
          <li>Copia la clave <code>anon ¬∑ public</code> (empieza con <code>eyJ</code>)</li>
          <li>P√©gala arriba y presiona <code>Guardar credenciales</code></li>
          <li>Luego <code>Probar conexi√≥n</code> para verificar</li>
        </ol>
      </div>

      <!-- Gu√≠a tablas SQL -->
      <div class="stepGuide" style="margin-top:12px">
        <h4>üóÑ ¬øLas tablas no existen a√∫n?</h4>
        <ol>
          <li>En tu dashboard ‚Üí <code>SQL Editor</code></li>
          <li>Ejecuta el script de creaci√≥n de tablas que te pas√©</li>
          <li>Aseg√∫rate de desactivar RLS o crear pol√≠ticas</li>
        </ol>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Supabase dynamic loader
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let supabase = null;

async function loadSupabaseClient(url, key) {
  if (!url || !key) return null;
  try {
    const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
    return createClient(url, key);
  } catch(e) {
    console.error("Error loading supabase client", e);
    return null;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Credenciales en localStorage
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CRED_KEY = "fabre_sb_credentials";

function loadCredentials() {
  try {
    const raw = localStorage.getItem(CRED_KEY);
    if (!raw) return { url:"", key:"" };
    return JSON.parse(raw);
  } catch { return { url:"", key:"" }; }
}
function saveCredentials(url, key) {
  localStorage.setItem(CRED_KEY, JSON.stringify({ url: url.trim(), key: key.trim() }));
}
function clearCredentials() {
  localStorage.removeItem(CRED_KEY);
}

function isValidJWT(str) {
  return typeof str === "string" && str.startsWith("eyJ") && str.length > 100;
}
function isValidURL(str) {
  try { new URL(str); return str.includes("supabase.co"); }
  catch { return false; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Init Supabase al arrancar
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function initSupabase() {
  const creds = loadCredentials();
  if (creds.url && creds.key) {
    supabase = await loadSupabaseClient(creds.url, creds.key);
    window.supabase = supabase;
  }
  updateConnStatusBadge();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Badge de conexi√≥n (top right)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function updateConnStatusBadge() {
  const box = document.getElementById("dbConnStatus");
  const creds = loadCredentials();

  if (!creds.url || !creds.key) {
    box.textContent = "‚ö™ Supabase no configurado";
    box.style.background = "#222"; box.style.borderColor = "#555";
    return;
  }
  if (!supabase) {
    box.textContent = "üü° Cargando cliente‚Ä¶";
    box.style.background = "#332"; box.style.borderColor = "#aa0";
    return;
  }

  box.textContent = "üîÑ Verificando‚Ä¶";
  box.style.background = "#332"; box.style.borderColor = "#aa0";

  try {
    const { error } = await supabase.from("settings").select("key").limit(1);
    if (error) throw error;
    const hora = new Date().toLocaleTimeString("es-US",{hour:"2-digit",minute:"2-digit"});
    box.textContent = `üü¢ Conectado ‚Äî ${hora}`;
    box.style.background = "#043"; box.style.borderColor = "#0f5";
  } catch(e) {
    box.textContent = "üî¥ Sin conexi√≥n";
    box.style.background = "#400"; box.style.borderColor = "#f55";
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Modal Supabase Config
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openSupaConfigModal() {
  const creds = loadCredentials();
  const urlIn = document.getElementById("sbUrlInput");
  const keyIn = document.getElementById("sbKeyInput");

  urlIn.value = creds.url || "";
  keyIn.value = creds.key || "";

  updateModalPreviews();
  updateModalConnStatus("checking", "Esperando prueba‚Ä¶");
  document.getElementById("sbTestResult").style.display = "none";
  document.getElementById("supaConfigModal").classList.add("show");
}
function closeSupaConfigModal() {
  document.getElementById("supaConfigModal").classList.remove("show");
}

function updateModalPreviews() {
  const url = document.getElementById("sbUrlInput").value.trim();
  const key = document.getElementById("sbKeyInput").value.trim();

  const urlPrev = document.getElementById("sbUrlPreview");
  urlPrev.textContent = url ? url : "‚Äî";

  const keyPrev = document.getElementById("sbKeyPreview");
  if (key.length > 20) {
    keyPrev.textContent = key.slice(0,20) + "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + key.slice(-10);
  } else {
    keyPrev.textContent = key ? key : "‚Äî";
  }

  // Validaci√≥n visual
  const urlInput = document.getElementById("sbUrlInput");
  const keyInput = document.getElementById("sbKeyInput");
  const keyTag = document.getElementById("anonKeyTag");

  urlInput.className = url ? (isValidURL(url) ? "hasValue" : "empty") : "";
  keyInput.className = key ? (isValidJWT(key) ? "hasValue" : "empty") : "";

  if (key) {
    if (isValidJWT(key)) {
      keyTag.innerHTML = '<span class="tagValid">‚úì formato JWT v√°lido</span>';
    } else {
      keyTag.innerHTML = '<span class="tagInvalid">‚úó formato incorrecto (debe empezar con eyJ)</span>';
    }
  } else {
    keyTag.innerHTML = "";
  }
}

function updateModalConnStatus(state, text) {
  const el = document.getElementById("modalConnStatus");
  const txt = document.getElementById("modalConnText");
  el.className = "connStatus " + state;
  txt.textContent = text;
}

document.getElementById("sbUrlInput").addEventListener("input", updateModalPreviews);
document.getElementById("sbKeyInput").addEventListener("input", updateModalPreviews);

document.getElementById("btnSbSave").addEventListener("click", async () => {
  const url = document.getElementById("sbUrlInput").value.trim();
  const key = document.getElementById("sbKeyInput").value.trim();

  if (!url) return toast("‚ùå Ingresa la URL del proyecto");
  if (!isValidURL(url)) return toast("‚ùå URL inv√°lida ‚Äî debe ser https://xxxx.supabase.co");
  if (!key) return toast("‚ùå Ingresa la Anon Key");
  if (!isValidJWT(key)) return toast("‚ùå La Anon Key debe empezar con 'eyJ' y tener ~200 caracteres");

  saveCredentials(url, key);
  supabase = await loadSupabaseClient(url, key);
  window.supabase = supabase;

  toast("‚úÖ Credenciales guardadas");
  updateModalPreviews();
  await updateConnStatusBadge();
});

document.getElementById("btnSbTest").addEventListener("click", async () => {
  const url = document.getElementById("sbUrlInput").value.trim();
  const key = document.getElementById("sbKeyInput").value.trim();
  const result = document.getElementById("sbTestResult");

  if (!url || !key) {
    return toast("Primero guarda las credenciales");
  }

  updateModalConnStatus("checking", "Probando conexi√≥n‚Ä¶");
  result.style.display = "block";
  result.style.background = "rgba(255,200,50,.08)";
  result.style.border = "1px solid rgba(255,200,50,.3)";
  result.style.color = "#ffc832";
  result.textContent = "‚è≥ Conectando con Supabase‚Ä¶";

  try {
    const testClient = await loadSupabaseClient(url, key);
    if (!testClient) throw new Error("No se pudo crear el cliente");

    // Test 1: ping
    const { error: e1 } = await testClient.from("settings").select("key").limit(1);

    if (e1) {
      // Puede ser que la tabla settings no exista ‚Äî probar bills
      const { error: e2 } = await testClient.from("bills").select("id").limit(1);
      if (e2) {
        throw new Error(e2.message || "Error de conexi√≥n");
      }
    }

    updateModalConnStatus("connected", "‚úÖ Conexi√≥n exitosa");
    result.style.background = "rgba(46,229,157,.08)";
    result.style.border = "1px solid rgba(46,229,157,.3)";
    result.style.color = "#2ee59d";
    result.textContent = "‚úÖ Conexi√≥n exitosa con Supabase. Las tablas responden correctamente.";

    await updateConnStatusBadge();

  } catch(e) {
    updateModalConnStatus("error", "‚ùå Error de conexi√≥n");
    result.style.background = "rgba(255,77,109,.08)";
    result.style.border = "1px solid rgba(255,77,109,.3)";
    result.style.color = "#ff4d6d";

    let msg = e?.message || String(e);
    let hint = "";
    if (msg.includes("Invalid API key") || msg.includes("apikey")) {
      hint = "\n\nüí° La Anon Key es inv√°lida. Ve a Settings ‚Üí API en tu dashboard y copia la clave 'anon ¬∑ public' (empieza con eyJ).";
    } else if (msg.includes("relation") || msg.includes("does not exist")) {
      hint = "\n\nüí° La conexi√≥n funciona pero falta la tabla. Ejecuta el SQL de creaci√≥n de tablas en tu dashboard.";
    } else if (msg.includes("fetch") || msg.includes("network")) {
      hint = "\n\nüí° Error de red. Verifica que la URL del proyecto sea correcta.";
    }
    result.textContent = "‚ùå Error: " + msg + hint;
  }
});

document.getElementById("btnSbClear").addEventListener("click", () => {
  if (!confirm("¬øBorrar las credenciales guardadas?")) return;
  clearCredentials();
  supabase = null;
  window.supabase = null;
  document.getElementById("sbUrlInput").value = "";
  document.getElementById("sbKeyInput").value = "";
  updateModalPreviews();
  updateModalConnStatus("checking", "Sin credenciales");
  document.getElementById("sbTestResult").style.display = "none";
  updateConnStatusBadge();
  toast("Credenciales borradas");
});

document.getElementById("btnOpenSupaConfig").addEventListener("click", openSupaConfigModal);
document.getElementById("btnSupaConfigClose").addEventListener("click", closeSupaConfigModal);
document.getElementById("supaConfigModal").addEventListener("click", e => {
  if (e.target === document.getElementById("supaConfigModal")) closeSupaConfigModal();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PWA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function registerSW() {
  if (!("serviceWorker" in navigator)) return null;
  try { return await navigator.serviceWorker.register("./sw.js"); }
  catch { return null; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IndexedDB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const DB_NAME = "fabre_bills_db";
const DB_VER  = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("settings")) db.createObjectStore("settings");
      if (!db.objectStoreNames.contains("bills")) {
        const st = db.createObjectStore("bills", { keyPath: "id" });
        st.createIndex("by_name", "name", { unique: false });
        st.createIndex("by_next_due", "next_due_date", { unique: false });
      }
      if (!db.objectStoreNames.contains("payments")) {
        const st = db.createObjectStore("payments", { keyPath: "id" });
        st.createIndex("by_bill", "bill_id", { unique: false });
        st.createIndex("by_date", "pay_date", { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function uid() {
  return (crypto.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + "_" + Date.now()));
}

async function getSetting(key, fallback) {
  try {
    const db = await openDB();
    return await new Promise((resolve,reject) => {
      const t = db.transaction("settings","readonly");
      const r = t.objectStore("settings").get(key);
      r.onsuccess = () => resolve(r.result ?? fallback);
      r.onerror = () => reject(r.error);
    });
  } catch { return fallback; }
}
async function setSetting(key, value) {
  const db = await openDB();
  return new Promise((resolve,reject) => {
    const t = db.transaction("settings","readwrite");
    const r = t.objectStore("settings").put(value, key);
    r.onsuccess = () => resolve(true);
    r.onerror = () => reject(r.error);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DB Mode router
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function getDbMode() { return await getSetting("__dbMode","local"); }
async function setDbMode(mode) { await setSetting("__dbMode", mode); }

const SB_TABLE_BILLS    = "bills";
const SB_TABLE_PAYMENTS = "payments";

async function putBill(bill) {
  return (await getDbMode()) === "supabase" ? putBill_SUPABASE(bill) : putBill_LOCAL(bill);
}
async function listBills() {
  return (await getDbMode()) === "supabase" ? listBills_SUPABASE() : listBills_LOCAL();
}
async function deleteBill(billId) {
  return (await getDbMode()) === "supabase" ? deleteBill_SUPABASE(billId) : deleteBill_LOCAL(billId);
}
async function addPayment(payment) {
  return (await getDbMode()) === "supabase" ? addPayment_SUPABASE(payment) : addPayment_LOCAL(payment);
}
async function listPaymentsByBill(billId) {
  return (await getDbMode()) === "supabase" ? listPaymentsByBill_SUPABASE(billId) : listPaymentsByBill_LOCAL(billId);
}
async function deletePayment(paymentId) {
  return (await getDbMode()) === "supabase" ? deletePayment_SUPABASE(paymentId) : deletePayment_LOCAL(paymentId);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Supabase CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getSB() {
  const sb = supabase || window.supabase;
  if (!sb) throw new Error("Supabase no configurado. Haz clic en ‚öôÔ∏è Supabase para configurarlo.");
  return sb;
}

async function putBill_SUPABASE(bill) {
  const { error } = await getSB().from(SB_TABLE_BILLS).upsert(bill,{onConflict:"id"});
  if (error) throw error;
}
async function listBills_SUPABASE() {
  const { data, error } = await getSB().from(SB_TABLE_BILLS).select("*");
  if (error) throw error;
  return data || [];
}
async function deleteBill_SUPABASE(billId) {
  await getSB().from(SB_TABLE_PAYMENTS).delete().eq("bill_id",billId);
  const { error } = await getSB().from(SB_TABLE_BILLS).delete().eq("id",billId);
  if (error) throw error;
}
async function addPayment_SUPABASE(payment) {
  const { error } = await getSB().from(SB_TABLE_PAYMENTS).upsert(payment,{onConflict:"id"});
  if (error) throw error;
}
async function listPaymentsByBill_SUPABASE(billId) {
  const { data, error } = await getSB().from(SB_TABLE_PAYMENTS).select("*").eq("bill_id",billId);
  if (error) throw error;
  return (data||[]).sort((a,b) => a.pay_date > b.pay_date ? -1 : 1);
}
async function deletePayment_SUPABASE(paymentId) {
  const { error } = await getSB().from(SB_TABLE_PAYMENTS).delete().eq("id",paymentId);
  if (error) throw error;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Local IndexedDB CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function putBill_LOCAL(bill) {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction("bills","readwrite");
    const r = t.objectStore("bills").put(bill);
    r.onsuccess = () => res(true);
    r.onerror = () => rej(r.error);
  });
}
async function listBills_LOCAL() {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction("bills","readonly");
    const out=[];
    const r = t.objectStore("bills").openCursor();
    r.onsuccess = () => { const c=r.result; if(!c) return res(out); out.push(c.value); c.continue(); };
    r.onerror = () => rej(r.error);
  });
}
async function addPayment_LOCAL(payment) {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction("payments","readwrite");
    const r = t.objectStore("payments").put(payment);
    r.onsuccess = () => res(true);
    r.onerror = () => rej(r.error);
  });
}
async function listPaymentsByBill_LOCAL(billId) {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction("payments","readonly");
    const out=[];
    const r = t.objectStore("payments").index("by_bill").openCursor(IDBKeyRange.only(billId));
    r.onsuccess = () => { const c=r.result; if(!c) return res(out.sort((a,b)=>a.pay_date>b.pay_date?-1:1)); out.push(c.value); c.continue(); };
    r.onerror = () => rej(r.error);
  });
}
async function deletePayment_LOCAL(paymentId) {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction("payments","readwrite");
    const r = t.objectStore("payments").delete(paymentId);
    r.onsuccess = () => res(true);
    r.onerror = () => rej(r.error);
  });
}
async function deleteBill_LOCAL(billId) {
  const db = await openDB();
  return new Promise((res,rej) => {
    const t = db.transaction(["bills","payments"],"readwrite");
    t.objectStore("bills").delete(billId);
    const curReq = t.objectStore("payments").index("by_bill").openCursor(IDBKeyRange.only(billId));
    curReq.onsuccess = () => { const cur=curReq.result; if(!cur) return; t.objectStore("payments").delete(cur.value.id); cur.continue(); };
    t.oncomplete = () => res(true);
    t.onerror = () => rej(t.error);
  });
}
async function wipeDB() {
  return new Promise(res => {
    const req = indexedDB.deleteDatabase(DB_NAME);
    req.onsuccess = () => res(true);
    req.onerror = () => res(false);
    req.onblocked = () => res(false);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Helpers
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $ = id => document.getElementById(id);
const toast = m => {
  const t=$("toast"); t.textContent=m;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2800);
};

function todayISO() {
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function toISODate(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function parseISO(iso) {
  const [y,m,d]=iso.split("-").map(Number);
  return new Date(y,m-1,d);
}
function daysBetween(a,b) {
  return Math.floor((parseISO(b)-parseISO(a))/(1000*60*60*24));
}
function dueDateForMonth(y,m,dueDay) {
  const max=new Date(y,m+1,0).getDate();
  return new Date(y,m,Math.min(Math.max(1,Number(dueDay||1)),max));
}
function computeInitialNextDue(dueDay) {
  const now=new Date();
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const thisMonth=dueDateForMonth(now.getFullYear(),now.getMonth(),dueDay);
  if(thisMonth>=today) return toISODate(thisMonth);
  return toISODate(dueDateForMonth(now.getFullYear(),now.getMonth()+1,dueDay));
}
function computeNextDueAfterPay(currentNextDueISO,dueDay) {
  const base=currentNextDueISO?parseISO(currentNextDueISO):new Date();
  return toISODate(dueDateForMonth(base.getFullYear(),base.getMonth()+1,dueDay));
}
function fmtMoney(value,cur) {
  try { return new Intl.NumberFormat("en-US",{style:"currency",currency:cur}).format(Number(value||0)); }
  catch { return "$"+Number(value||0).toFixed(2); }
}
function escapeHtml(str) {
  return (str??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Settings
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildDueDayOptions() {
  const sel=$("dueDay"); sel.innerHTML="";
  for(let i=1;i<=31;i++){
    const opt=document.createElement("option");
    opt.value=String(i); opt.textContent=`D√≠a ${i}`;
    sel.appendChild(opt);
  }
}
async function getNameLibrary() { return await getSetting("billNameLibrary",[]); }
async function setNameLibrary(names) {
  const uniq=Array.from(new Set((names||[]).map(x=>String(x||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  await setSetting("billNameLibrary",uniq);
  return uniq;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   App state
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let cache={bills:[],currency:"USD",defaultRemindDays:7};
let editingId=null,payingBillId=null,histBillId=null,lastFocusTarget="form";

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Dropdowns
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function rebuildBillNameCombo(selectedValue="") {
  const lib=await getNameLibrary();
  const dbNames=(cache.bills||[]).map(b=>b.name).filter(Boolean);
  const all=await setNameLibrary([...lib,...dbNames]);
  const sel=$("billNameSelect");
  sel.innerHTML="";
  const opt0=document.createElement("option");
  opt0.value=""; opt0.textContent="Selecciona un bill‚Ä¶";
  sel.appendChild(opt0);
  for(const n of all){
    const opt=document.createElement("option");
    opt.value=n; opt.textContent=n;
    sel.appendChild(opt);
  }
  sel.value=selectedValue||"";
}
function rebuildPayBillSelect(selectedId="") {
  const sel=$("payBillSelect");
  sel.innerHTML="";
  const opt0=document.createElement("option");
  opt0.value=""; opt0.textContent="Selecciona un bill‚Ä¶";
  sel.appendChild(opt0);
  for(const b of cache.bills){
    const opt=document.createElement("option");
    opt.value=b.id;
    opt.textContent=`${b.name}${b.next_due_date?" | Pr√≥ximo: "+b.next_due_date:""}`;
    sel.appendChild(opt);
  }
  sel.value=selectedId||"";
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Notifications
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function enableNotifications() {
  if(!("Notification" in window)) return toast("Este navegador no soporta notificaciones");
  const perm=await Notification.requestPermission();
  toast(perm==="granted"?"Notificaciones activadas":"Notificaciones bloqueadas");
}
function showNotification(title,body) {
  try{ if(Notification.permission==="granted") new Notification(title,{body}); }catch{}
}
async function notifyDueBillsWhileOpen() {
  const remindDays=Number(await getSetting("defaultRemindDays",7));
  const today=todayISO();
  for(const b of cache.bills){
    if(!b.next_due_date) continue;
    const daysLeft=daysBetween(today,b.next_due_date);
    if(daysLeft>=0&&daysLeft>remindDays) continue;
    if(b.last_notified_date===today) continue;
    const txt=daysLeft<0?`VENCIDO hace ${Math.abs(daysLeft)} d√≠a(s)`:`Vence en ${daysLeft} d√≠a(s)`;
    showNotification("Bill: "+b.name,`${txt} ‚Äî ${b.next_due_date} ‚Äî ${fmtMoney(b.amount_monthly,cache.currency)}`);
    b.last_notified_date=today;
    await putBill(b);
  }
}
async function scheduleAllBills() {
  const reg=await navigator.serviceWorker?.ready;
  if(!reg) return toast("Service Worker no disponible.");
  if(Notification.permission!=="granted") return toast("Primero activa notificaciones.");
  if(!("TimestampTrigger" in window)) return toast("Tu navegador no soporta notificaciones programadas.");
  let scheduled=0;
  const remindDays=Number(await getSetting("defaultRemindDays",7));
  const now=Date.now();
  for(const b of cache.bills){
    if(!b.next_due_date) continue;
    const d=parseISO(b.next_due_date); d.setHours(9,0,0,0);
    const dueTs=d.getTime();
    const soonTs=remindDays>0?(dueTs-remindDays*864e5):null;
    if(soonTs&&soonTs>now){
      try{ await reg.showNotification("Bill por vencer: "+b.name,{body:`Vence el ${b.next_due_date}`,tag:`soon-${b.id}`,showTrigger:new TimestampTrigger(soonTs)}); scheduled++; }catch{}
    }
    if(dueTs>now){
      try{ await reg.showNotification("Bill HOY vence: "+b.name,{body:`Vence hoy (${b.next_due_date})`,tag:`due-${b.id}`,showTrigger:new TimestampTrigger(dueTs)}); scheduled++; }catch{}
    }
  }
  toast(scheduled?`Alertas programadas: ${scheduled}`:"No se pudo programar.");
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Render
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function statusForBill(b,remindDays,today) {
  const d=daysBetween(today,b.next_due_date);
  if(d<0) return {key:"overdue",label:`Vencido (${Math.abs(d)}d)`,daysLeft:d};
  if(d<=remindDays) return {key:"soon",label:`Por vencer (${d}d)`,daysLeft:d};
  return {key:"ok",label:`Al d√≠a (${d}d)`,daysLeft:d};
}

async function refresh() {
  cache.currency=await getSetting("currency","USD");
  cache.defaultRemindDays=Number(await getSetting("defaultRemindDays",7));
  $("currency").value=cache.currency;
  $("currencyLabel").textContent=cache.currency;
  $("remindDays").value=String(cache.defaultRemindDays);
  try {
    cache.bills=await listBills();
    cache.bills.sort((a,b)=>a.next_due_date>b.next_due_date?1:-1);
  } catch(e) {
    toast("‚ö†Ô∏è Error al cargar bills: "+(e?.message||e));
    cache.bills=[];
  }
  await rebuildBillNameCombo($("billNameSelect")?.value||"");
  rebuildPayBillSelect($("payBillSelect")?.value||"");
  render();
  await notifyDueBillsWhileOpen();
}

function render() {
  const today=todayISO();
  const remindDays=Number($("remindDays").value||cache.defaultRemindDays);
  const filter=$("filter").value;
  const q=($("search").value||"").trim().toLowerCase();

  const total=cache.bills.reduce((s,b)=>s+Number(b.amount_monthly||0),0);
  let cOver=0,cSoon=0,cOk=0;
  for(const b of cache.bills){
    const st=statusForBill(b,remindDays,today);
    if(st.key==="overdue")cOver++;
    else if(st.key==="soon")cSoon++;
    else cOk++;
  }
  $("kTotalMonthly").textContent=fmtMoney(total,cache.currency);
  $("kOverdue").textContent=String(cOver);
  $("kSoon").textContent=String(cSoon);
  $("kOk").textContent=String(cOk);
  $("kOverdueSub").textContent=cOver?"Tienes bills vencidos":"‚Äî";
  $("kSoonSub").textContent=cSoon?`Vencen en <= ${remindDays} d√≠as`:"‚Äî";
  const bp=[];
  if(cOver) bp.push(`‚ö†Ô∏è ${cOver} vencido(s)`);
  if(cSoon) bp.push(`‚è≥ ${cSoon} por vencer`);
  if(!bp.length) bp.push("‚úÖ Todo al d√≠a");
  $("bannerText").textContent=bp.join(" | ");

  const items=cache.bills.filter(b=>{
    const st=statusForBill(b,remindDays,today);
    if(filter!=="all"&&st.key!==filter) return false;
    if(q){
      const blob=`${b.name||""} ${b.category||""} ${b.vendor||""}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });

  const tb=$("tbody"); tb.innerHTML="";
  for(const b of items){
    const st=statusForBill(b,remindDays,today);
    const pillClass=st.key==="overdue"?"pill overdue":st.key==="soon"?"pill soon":"pill ok";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><span class="${pillClass}">${st.label}</span></td>
      <td><div><b>${escapeHtml(b.name)}</b></div><div class="muted">${escapeHtml(b.category||"")}</div></td>
      <td class="mono">${escapeHtml(b.due_day?"D√≠a "+b.due_day:"")}</td>
      <td class="mono">${fmtMoney(b.amount_monthly,cache.currency)}</td>
      <td class="mono">${escapeHtml(b.last_paid_date||"‚Äî")}</td>
      <td class="mono"><b>${escapeHtml(b.next_due_date||"‚Äî")}</b></td>
      <td>${escapeHtml(b.method||"")}</td>
      <td>${escapeHtml(b.vendor||"")}</td>
      <td>
        <div class="actions">
          <button class="ok" data-pay="${b.id}">Pagar</button>
          <button data-hist="${b.id}">Historial</button>
          <button data-edit="${b.id}">Editar</button>
          <button class="danger" data-del="${b.id}">Borrar</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll("button[data-pay]").forEach(btn=>btn.onclick=()=>beginPay(btn.dataset.pay));
  tb.querySelectorAll("button[data-hist]").forEach(btn=>btn.onclick=()=>openHistory(btn.dataset.hist));
  tb.querySelectorAll("button[data-edit]").forEach(btn=>btn.onclick=()=>beginEdit(btn.dataset.edit));
  tb.querySelectorAll("button[data-del]").forEach(btn=>btn.onclick=async()=>{
    if(!confirm("¬øBorrar este bill y su historial?")) return;
    await deleteBill(btn.dataset.del);
    toast("Borrado");
    if(payingBillId===btn.dataset.del) resetPayBox();
    if(editingId===btn.dataset.del) clearForm();
    if(histBillId===btn.dataset.del) closeHistory();
    await refresh();
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Form
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function clearForm() {
  editingId=null;
  $("editId").textContent="Nuevo";
  $("billNameSelect").value="";
  $("amount").value="";
  $("dueDay").value="1";
  $("category").value="";
  $("vendor").value="";
  $("method").value="Cash";
  $("formHint").textContent="‚Äî";
}
function beginEdit(billId) {
  const b=cache.bills.find(x=>x.id===billId); if(!b) return;
  editingId=billId;
  $("editId").textContent=billId;
  $("billNameSelect").value=b.name||"";
  $("amount").value=b.amount_monthly??"";
  $("dueDay").value=String(b.due_day??1);
  $("category").value=b.category||"";
  $("vendor").value=b.vendor||"";
  $("method").value=b.method||"Cash";
  $("formHint").textContent="Editando. Guarda para aplicar cambios.";
  // switch to form tab
  switchTab("tabForm");
  toast("Modo edici√≥n");
}
$("billForm").onsubmit=async(ev)=>{
  ev.preventDefault();
  const name=($("billNameSelect").value||"").trim();
  const amount=Number($("amount").value);
  const dueDay=Number($("dueDay").value);
  if(!name) return toast("Selecciona (o agrega) el nombre del bill");
  if(!Number.isFinite(amount)||amount<=0) return toast("Monto inv√°lido");
  if(!Number.isFinite(dueDay)||dueDay<1||dueDay>31) return toast("D√≠a de vencimiento inv√°lido");
  const currency=$("currency").value;
  await setSetting("currency",currency);
  cache.currency=currency; $("currencyLabel").textContent=currency;
  const lib=await getNameLibrary();
  await setNameLibrary([...lib,name]);
  const bill=editingId?(cache.bills.find(x=>x.id===editingId)||{id:editingId}):{id:uid()};
  bill.name=name;
  bill.amount_monthly=Number(amount.toFixed(2));
  bill.due_day=dueDay;
  bill.category=$("category").value.trim()||null;
  bill.vendor=$("vendor").value.trim()||null;
  bill.method=$("method").value;
  if(!bill.next_due_date) bill.next_due_date=computeInitialNextDue(dueDay);
  await putBill(bill);
  toast(editingId?"Bill actualizado":"Bill creado");
  clearForm();
  await refresh();
};
$("btnClear").onclick=()=>{ clearForm(); toast("Formulario limpio"); };

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Pay
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetPayBox() {
  payingBillId=null;
  $("payBillName").textContent="‚Äî";
  $("payBillSelect").value="";
  $("payDate").value=todayISO();
  $("payAmount").value="";
  $("payNote").value="";
  $("btnConfirmPay").disabled=true;
}
function setPayFromBill(b) {
  payingBillId=b.id;
  $("payBillName").textContent=b.name;
  $("payDate").value=todayISO();
  $("payAmount").value=String(b.amount_monthly??"");
  $("payNote").value="";
  $("btnConfirmPay").disabled=false;
}
function beginPay(billId) {
  const b=cache.bills.find(x=>x.id===billId); if(!b) return;
  $("payBillSelect").value=billId;
  setPayFromBill(b);
  switchTab("tabPay");
  toast("Listo para marcar pagado");
}
$("btnPayLoad").onclick=()=>{
  const id=$("payBillSelect").value;
  const b=cache.bills.find(x=>x.id===id);
  if(!b) return toast("Selecciona un bill");
  setPayFromBill(b); toast("Bill cargado");
};
$("payBillSelect").onchange=()=>{
  const id=$("payBillSelect").value;
  const b=cache.bills.find(x=>x.id===id);
  b?setPayFromBill(b):resetPayBox();
};
$("btnConfirmPay").onclick=async()=>{
  if(!payingBillId) return;
  const b=cache.bills.find(x=>x.id===payingBillId); if(!b) return;
  const payDate=$("payDate").value||todayISO();
  const payAmount=Number($("payAmount").value);
  if(!Number.isFinite(payAmount)||payAmount<=0) return toast("Monto pagado inv√°lido");
  const payment={
    id:uid(),bill_id:b.id,bill_name:b.name,
    pay_date:payDate,amount_paid:Number(payAmount.toFixed(2)),
    note:($("payNote").value||"").trim()||null,
    created_at:new Date().toISOString()
  };
  await addPayment(payment);
  b.last_paid_date=payDate;
  b.last_paid_amount=Number(payAmount.toFixed(2));
  b.next_due_date=computeNextDueAfterPay(b.next_due_date,b.due_day);
  b.last_notified_date=null;
  await putBill(b);
  toast(`Pagado. Pr√≥ximo: ${b.next_due_date}`);
  resetPayBox();
  await refresh();
  try{ await scheduleAllBills(); }catch{}
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   History modal
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openModal(){ $("modalBack").classList.add("show"); }
function closeModal(){ $("modalBack").classList.remove("show"); }
async function openHistory(billId){
  const b=cache.bills.find(x=>x.id===billId); if(!b) return;
  histBillId=billId;
  $("histTitle").textContent=`${b.name} | ${fmtMoney(b.amount_monthly,cache.currency)} | Pr√≥ximo: ${b.next_due_date}`;
  await renderHistory(); openModal();
}
function closeHistory(){ histBillId=null; $("histBody").innerHTML=""; closeModal(); }
async function renderHistory(){
  if(!histBillId) return;
  const pays=await listPaymentsByBill(histBillId);
  const total=pays.reduce((s,p)=>s+Number(p.amount_paid||0),0);
  $("histTotal").textContent=fmtMoney(total,cache.currency);
  $("histCount").textContent=String(pays.length);
  const tb=$("histBody"); tb.innerHTML="";
  for(const p of pays){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="mono">${escapeHtml(p.pay_date)}</td>
      <td class="mono">${fmtMoney(p.amount_paid,cache.currency)}</td>
      <td>${escapeHtml(p.note||"")}</td>
      <td><button class="danger" data-delpay="${p.id}">Borrar</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll("button[data-delpay]").forEach(btn=>btn.onclick=async()=>{
    if(!confirm("¬øBorrar este pago?")) return;
    await deletePayment(btn.dataset.delpay);
    toast("Pago borrado"); await renderHistory();
  });
}
$("btnHistCSV").onclick=async()=>{
  if(!histBillId) return;
  const b=cache.bills.find(x=>x.id===histBillId);
  const pays=await listPaymentsByBill(histBillId);
  const rows=[["bill","pay_date","amount_paid","note","currency"].join(",")];
  for(const p of pays.slice().reverse()){
    rows.push([`"${(b?.name||"").replaceAll('"','""')}"`,p.pay_date,Number(p.amount_paid||0).toFixed(2),`"${(p.note||"").replaceAll('"','""')}"`,cache.currency].join(","));
  }
  downloadFile(`historial_${(b?.name||"bill").replaceAll(" ","_")}.csv`,rows.join("\n"),"text/csv");
  toast("CSV exportado");
};
$("btnHistClose").onclick=closeHistory;
$("modalBack").onclick=e=>{ if(e.target===$("modalBack")) closeHistory(); };

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Bill name modal
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openBillNameModal(target="form"){
  lastFocusTarget=target;
  $("billNameNew").value="";
  $("billNameHint").textContent="‚Äî";
  $("billNameModalBack").classList.add("show");
  setTimeout(()=>$("billNameNew").focus(),60);
}
function closeBillNameModal(){ $("billNameModalBack").classList.remove("show"); }
$("btnAddBillName").onclick=()=>openBillNameModal("form");
$("btnPayAddBill").onclick=()=>openBillNameModal("pay");
$("btnBillNameClose").onclick=closeBillNameModal;
$("billNameModalBack").onclick=e=>{ if(e.target===$("billNameModalBack")) closeBillNameModal(); };
$("btnBillNameSave").onclick=async()=>{
  const n=($("billNameNew").value||"").trim();
  if(!n){ $("billNameHint").textContent="Escribe un nombre."; return; }
  await setNameLibrary([...await getNameLibrary(),n]);
  await rebuildBillNameCombo(n);
  $("billNameHint").textContent="Guardado ‚úÖ";
  toast("Nombre agregado.");
  closeBillNameModal();
  if(lastFocusTarget==="pay"){ resetPayBox(); $("amount").focus(); }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Tab navigation
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchTab(tabId){
  document.querySelectorAll(".tabPane").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".topNav button").forEach(b=>b.classList.remove("active"));
  $(tabId)?.classList.add("active");
  document.querySelector(`.topNav button[data-tab="${tabId}"]`)?.classList.add("active");
}
document.querySelectorAll(".topNav button").forEach(btn=>{
  btn.addEventListener("click",()=>switchTab(btn.dataset.tab));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Buttons misc
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$("remindDays").onchange=async()=>{ await setSetting("defaultRemindDays",Number($("remindDays").value)); toast("Aviso actualizado"); await refresh(); };
$("filter").onchange=()=>render();
$("search").oninput=()=>render();
$("btnRefresh").onclick=()=>refresh().then(()=>toast("Actualizado")).catch(()=>toast("Error"));
$("btnNotif").onclick=enableNotifications;
$("btnSchedule").onclick=async()=>{ await enableNotifications(); const reg=await registerSW(); if(!reg) toast("No se pudo registrar SW."); await refresh(); await scheduleAllBills(); };
$("btnInstallTips").onclick=()=>toast("Abre en Chrome y elige 'Instalar app'. Luego activa notificaciones y 'Programar alertas'.");

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DB mode selector
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(async()=>{
  const sel=$("dbMode");
  if(sel){ sel.value=await getDbMode(); sel.addEventListener("change",async()=>{ await setDbMode(sel.value); toast("DB: "+(sel.value==="supabase"?"Supabase":"Local")); await refresh(); }); }

  $("btnSync").addEventListener("click",async()=>{
    try{
      const sb=getSB();
      const localBills=await listBills_LOCAL();
      const db=await openDB();
      const localPayments=await new Promise((res,rej)=>{
        const t=db.transaction("payments","readonly"); const out=[];
        const r=t.objectStore("payments").openCursor();
        r.onsuccess=()=>{ const c=r.result; if(!c) return res(out); out.push(c.value); c.continue(); };
        r.onerror=()=>rej(r.error);
      });
      if(localBills.length){ const{error}=await sb.from(SB_TABLE_BILLS).upsert(localBills,{onConflict:"id"}); if(error) throw error; }
      if(localPayments.length){ const{error}=await sb.from(SB_TABLE_PAYMENTS).upsert(localPayments,{onConflict:"id"}); if(error) throw error; }
      toast("‚úÖ Sync OK: Local ‚Üí Supabase");
    }catch(e){ toast("Sync fall√≥: "+(e?.message||e)); }
  });
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Backup / Import / Reset
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function downloadFile(filename,content,mime="application/octet-stream"){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
$("btnBackup").onclick=async()=>{
  const db=await openDB();
  const allPays=await new Promise((res,rej)=>{ const t=db.transaction("payments","readonly"); const out=[]; const r=t.objectStore("payments").openCursor(); r.onsuccess=()=>{ const c=r.result; if(!c) return res(out); out.push(c.value); c.continue(); }; r.onerror=()=>rej(r.error); });
  const payload={
    meta:{app:"fabre_bills",version:4,exported_at:new Date().toISOString()},
    settings:{currency:await getSetting("currency","USD"),defaultRemindDays:await getSetting("defaultRemindDays",7),billNameLibrary:await getSetting("billNameLibrary",[])},
    bills:await listBills(),
    payments:allPays
  };
  downloadFile("backup_bills.json",JSON.stringify(payload,null,2),"application/json");
  toast("Backup descargado");
};
$("btnImport").onclick=()=>$("fileImport").click();
$("fileImport").onchange=async()=>{
  const f=$("fileImport").files?.[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(!data||!Array.isArray(data.bills)){ toast("JSON inv√°lido"); return; }
    if(data.settings?.currency) await setSetting("currency",data.settings.currency);
    if(Number.isFinite(Number(data.settings?.defaultRemindDays))) await setSetting("defaultRemindDays",Number(data.settings.defaultRemindDays));
    if(Array.isArray(data.settings?.billNameLibrary)) await setSetting("billNameLibrary",data.settings.billNameLibrary);
    for(const b of data.bills){ if(!b.id||!b.name) continue; if(!b.next_due_date&&b.due_day) b.next_due_date=computeInitialNextDue(b.due_day); await putBill(b); }
    if(Array.isArray(data.payments)) for(const p of data.payments){ if(!p.id||!p.bill_id||!p.pay_date) continue; await addPayment(p); }
    toast("Importaci√≥n completada"); await refresh();
  }catch(e){ console.error(e); toast("Error importando JSON"); }
  finally{ $("fileImport").value=""; }
};
$("btnReset").onclick=async()=>{
  if(!confirm("¬øBorrar TODA la base local de este dispositivo?")) return;
  const ok=await wipeDB();
  if(!ok) return toast("No se pudo borrar. Cierra otras pesta√±as.");
  toast("DB borrada"); location.reload();
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Boot
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(async()=>{
  const cur=await getSetting("currency",null); if(!cur) await setSetting("currency","USD");
  const rd=await getSetting("defaultRemindDays",null); if(rd===null||rd===undefined) await setSetting("defaultRemindDays",7);
  const lib=await getSetting("billNameLibrary",null); if(!Array.isArray(lib)) await setSetting("billNameLibrary",[]);

  buildDueDayOptions();
  $("dueDay").value="1";

  await initSupabase();
  await registerSW();
  await refresh();

  clearForm(); resetPayBox();

  setInterval(()=>{ notifyDueBillsWhileOpen().catch(()=>{}); }, 60000);
  setInterval(()=>{ updateConnStatusBadge(); }, 30000);
})();
</script>
</body>
</html>
