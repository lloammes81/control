<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Control de Bills (Supabase)</title>

  <!-- PWA (opcional) -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{
      --bg:#0b1220;--card:#111a2e;--muted:#a7b2cc;--text:#eef3ff;
      --line:rgba(255,255,255,.10);--accent:#4da3ff;--danger:#ff4d6d;--ok:#2ee59d;
      --shadow:0 10px 30px rgba(0,0,0,.35);--r:16px;--mono:ui-monospace,Menlo,Consolas,monospace;--sans:system-ui,Segoe UI,Roboto,Arial
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--text);background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06)}
    .chip label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{
      padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--text);outline:none
    }
    button{cursor:pointer;transition:.12s ease}
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    button.primary{background:rgba(77,163,255,.22);border-color:rgba(77,163,255,.35)}
    button.danger{background:rgba(255,77,109,.18);border-color:rgba(255,77,109,.35)}
    button.ok{background:rgba(46,229,157,.16);border-color:rgba(46,229,157,.30)}
    button.iconBtn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;line-height:1;padding:0;border-radius:12px}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .bd{padding:16px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:18px;margin-top:6px;font-family:var(--mono)}
    .kpi .sub{font-size:12px;margin-top:4px;color:rgba(238,243,255,.75)}
    form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:680px){form{grid-template-columns:1fr}}
    .row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:1040px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);position:sticky;top:0;background:rgba(17,26,46,.95)}
    .mono{font-family:var(--mono)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-size:12px}
    .pill.overdue{border-color:rgba(255,77,109,.55);background:rgba(255,77,109,.12)}
    .pill.soon{border-color:rgba(77,163,255,.55);background:rgba(77,163,255,.12)}
    .pill.ok{border-color:rgba(46,229,157,.55);background:rgba(46,229,157,.10)}
    .toast{position:fixed;right:16px;bottom:16px;background:rgba(17,26,46,.95);border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:var(--shadow);display:none;max-width:560px;z-index:9999}
    .toast.show{display:block}
    .banner{padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .modalBack{position:fixed; inset:0; background:rgba(0,0,0,.55);display:none; align-items:center; justify-content:center; padding:14px;z-index:9998}
    .modal{width:min(980px, 100%);max-height:88vh;overflow:auto;background:rgba(17,26,46,.98);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .modal.smallModal{width:min(520px,100%);}
    .modal .hd{position:sticky;top:0;background:rgba(17,26,46,.98);z-index:2}
    .modalBack.show{display:flex}
  </style>
</head>

<body>
  <div id="dbConnStatus" style="
    position: fixed; top: 8px; right: 8px;
    background: #222; border: 1px solid #555;
    padding: 8px 14px; border-radius: 12px; color: white;
    font-size: 13px; z-index: 10000;">
    Verificando conexi√≥n‚Ä¶
  </div>

  <img src="logo.svg" width="80" alt="Bills Control Logo" style="border-radius:16px; margin:16px 0 0 18px;">

  <div class="wrap">
    <header>
      <div>
        <h1>Control de Bills (Pagos Mensuales) ‚Äî Supabase</h1>
        <div class="muted">Nombre del bill con combo + bot√≥n ‚Äú+‚Äù | Vencimiento con combo | Historial + PWA.</div>
      </div>
      <div class="toolbar">
        <button class="ok" id="btnInstallTips" type="button">C√≥mo instalar</button>
        <button class="ok" id="btnNotif" type="button">Activar notificaciones</button>
        <button class="ok" id="btnSchedule" type="button">Programar alertas</button>

        <div class="chip">
          <label for="filter">Filtro</label>
          <select id="filter">
            <option value="all">Todos</option>
            <option value="overdue">Vencidos</option>
            <option value="soon">Por vencer</option>
            <option value="ok">Al d√≠a</option>
          </select>
        </div>
      </div>
    </header>

    <div class="card" style="margin-bottom:12px;">
      <div class="hd">
        <div class="muted">Resumen</div>
        <div class="muted">Moneda: <span id="currencyLabel">USD</span></div>
      </div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total mensual (todos)</div>
            <div class="value" id="kTotalMonthly">$0.00</div>
            <div class="sub">Suma de montos mensuales</div>
          </div>
          <div class="kpi">
            <div class="label">Vencidos</div>
            <div class="value" id="kOverdue">0</div>
            <div class="sub" id="kOverdueSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Por vencer</div>
            <div class="value" id="kSoon">0</div>
            <div class="sub" id="kSoonSub">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Al d√≠a</div>
            <div class="value" id="kOk">0</div>
            <div class="sub">‚Äî</div>
          </div>
        </div>

        <div style="margin-top:12px" class="banner">
          <div class="muted" id="bannerText">‚Äî</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <span class="muted">Avisar con:</span>
            <select id="remindDays">
              <option value="0">0 d√≠as</option>
              <option value="1">1 d√≠a</option>
              <option value="3">3 d√≠as</option>
              <option value="5">5 d√≠as</option>
              <option value="7" selected>7 d√≠as</option>
              <option value="10">10 d√≠as</option>
              <option value="15">15 d√≠as</option>
            </select>
            <span class="muted">La app intentar√° programar alertas (seg√∫n soporte del navegador).</span>
          </div>
        </div>

        <div class="small" style="margin-top:10px">Datos guardados en Supabase (online).</div>
      </div>
    </div>

    <div class="grid">
      <!-- FORM -->
      <div class="card">
        <div class="hd">
          <div class="muted">Agregar / Editar bill</div>
          <div class="muted">ID: <span id="editId">Nuevo</span></div>
        </div>
        <div class="bd">
          <form id="billForm">
            <div style="grid-column:1/-1;">
              <div class="muted">Nombre del bill</div>
              <div class="row" style="margin-top:8px;">
                <select id="billNameSelect" style="flex:1;min-width:260px;" required></select>
                <button class="ok iconBtn" type="button" id="btnAddBillName" title="Agregar bill">+</button>
              </div>
              <div class="muted" style="margin-top:6px;">Si no est√° en la lista, agr√©galo con ‚Äú+‚Äù.</div>
            </div>

            <div>
              <div class="muted">Monto mensual</div>
              <input id="amount" type="number" step="0.01" min="0" placeholder="Ej: 120.50" required>
            </div>

            <div>
              <div class="muted">D√≠a de vencimiento (cada mes)</div>
              <select id="dueDay" required></select>
              <div class="muted" style="margin-top:6px;">* Si el mes no tiene ese d√≠a (31), se usa el √∫ltimo d√≠a del mes.</div>
            </div>

            <div>
              <div class="muted">M√©todo</div>
              <select id="method">
                <option>Cash</option><option>Card</option><option>Transfer</option><option>Zelle</option><option>Check</option><option>AutoPay</option>
              </select>
              <div class="muted" style="margin-top:6px;">Moneda</div>
              <select id="currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="DOP">DOP</option>
                <option value="MXN">MXN</option>
              </select>
            </div>

            <div class="row">
              <input id="category" type="text" placeholder="Categor√≠a (opcional): Utilities, Rent, Insurance..." style="flex:1;min-width:240px;" maxlength="40">
              <input id="vendor" type="text" placeholder="Proveedor (opcional): FPL, AT&T..." style="width:260px;" maxlength="60">
            </div>

            <div class="row">
              <button class="primary" type="submit">Guardar bill</button>
              <button type="button" id="btnClear">Limpiar</button>
              <span class="muted" id="formHint">‚Äî</span>
            </div>
          </form>
        </div>
      </div>

      <!-- PAGAR -->
      <div class="card">
        <div class="hd">
          <div class="muted">Marcar pagado</div>
          <div class="muted">Bill: <span id="payBillName">‚Äî</span></div>
        </div>
        <div class="bd">
          <div class="muted">Selecciona el bill. Si no existe, agr√©galo con ‚Äú+‚Äù y luego cr√©alo en el formulario.</div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1;min-width:260px;">
              <div class="muted">Seleccionar bill</div>
              <select id="payBillSelect" style="width:100%"></select>
            </div>
            <button class="ok iconBtn" type="button" id="btnPayAddBill" title="Agregar bill">+</button>
            <button class="ok" type="button" id="btnPayLoad">Cargar</button>
          </div>

          <div style="margin-top:10px" class="row">
            <div style="flex:1;min-width:240px;">
              <div class="muted">Fecha de pago</div>
              <input id="payDate" type="date">
            </div>
            <div style="width:240px;">
              <div class="muted">Monto pagado</div>
              <input id="payAmount" type="number" step="0.01" min="0">
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <input id="payNote" type="text" placeholder="Nota (opcional)" style="flex:1;min-width:240px;" maxlength="120">
            <button class="ok" id="btnConfirmPay" type="button" disabled>Confirmar pago</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Al confirmar: guarda el pago en historial y calcula la pr√≥xima fecha (mes siguiente).
          </div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card" style="margin-top:12px;">
      <div class="hd">
        <div class="muted">Bills</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="search" type="text" placeholder="Buscar (nombre, categor√≠a, proveedor)" style="min-width:280px;">
          <button id="btnRefresh" type="button">Actualizar</button>
        </div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Estado</th>
                <th>Bill</th>
                <th>Vence</th>
                <th class="mono">Monto mensual</th>
                <th>√öltimo pago</th>
                <th>Pr√≥ximo pago</th>
                <th>M√©todo</th>
                <th>Proveedor</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px;">
          * Si tu navegador NO soporta ‚Äúnotificaci√≥n programada‚Äù, igual te avisa cuando la app est√° abierta.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL HISTORIAL -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="hd">
        <div>
          <div style="font-weight:700">Historial de pagos</div>
          <div class="small" id="histTitle">‚Äî</div>
        </div>
        <div class="actions">
          <button id="btnHistCSV" type="button">Exportar CSV</button>
          <button class="danger" id="btnHistClose" type="button">Cerrar</button>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="justify-content:space-between">
          <div class="small">Total pagado: <span class="mono" id="histTotal">‚Äî</span></div>
          <div class="small">Pagos: <span class="mono" id="histCount">0</span></div>
        </div>
        <div style="margin-top:12px" class="tableWrap">
          <table style="min-width:860px">
            <thead>
              <tr>
                <th>Fecha</th>
                <th class="mono">Monto</th>
                <th>Nota</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: AGREGAR NOMBRE DE BILL -->
  <div class="modalBack" id="billNameModalBack">
    <div class="modal smallModal">
      <div class="hd">
        <div>
          <div style="font-weight:700">Agregar nombre de bill</div>
          <div class="small">Esto lo agrega al combo. Luego crea el bill completo (monto + vencimiento) y guarda.</div>
        </div>
        <div class="actions">
          <button class="danger" id="btnBillNameClose" type="button">Cerrar</button>
        </div>
      </div>
      <div class="bd">
        <div class="muted">Nombre</div>
        <input id="billNameNew" type="text" placeholder="Ej: Luz / Renta / Seguro..." style="width:100%;margin-top:8px" maxlength="60">
        <div class="row" style="margin-top:12px;">
          <button class="ok" id="btnBillNameSave" type="button">Guardar</button>
          <span class="muted" id="billNameHint">‚Äî</span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ======= CONFIG SUPABASE =======
    const SUPABASE_URL = "https://bgyfrhcrqnoayqrntzom.supabase.co";
    const SUPABASE_KEY = "sb_publishable_eqw-StLRlDsZdALPoUTrfw_nYJ7uXCx"; // anon/public key
    const SB_TABLE_BILLS = "bills";
    const SB_TABLE_PAYMENTS = "payments";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    window.supabase = supabase;

    // ======= UTIL =======
    const $ = (id)=>document.getElementById(id);
    const toast = (m)=>{
      const t=$("toast");
      if(!t) return;
      t.textContent=m;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),2400);
    };

    function uid() {
      return (crypto.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + "_" + Date.now()));
    }

    function todayISO() {
      const d=new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    function toISODate(d) {
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseISO(iso) {
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function daysBetween(aISO, bISO) {
      const a = parseISO(aISO);
      const b = parseISO(bISO);
      const ms = (b.getTime() - a.getTime());
      return Math.floor(ms / (1000*60*60*24));
    }
    function lastDayOfMonth(year, monthIndex0) {
      return new Date(year, monthIndex0 + 1, 0).getDate();
    }
    function dueDateForMonth(year, monthIndex0, dueDay) {
      const max = lastDayOfMonth(year, monthIndex0);
      const day = Math.min(Math.max(1, Number(dueDay||1)), max);
      return new Date(year, monthIndex0, day);
    }
    function computeInitialNextDue(dueDay) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const thisMonthDue = dueDateForMonth(now.getFullYear(), now.getMonth(), dueDay);
      if (thisMonthDue >= today) return toISODate(thisMonthDue);
      const nextMonthDue = dueDateForMonth(now.getFullYear(), now.getMonth()+1, dueDay);
      return toISODate(nextMonthDue);
    }
    function computeNextDueAfterPay(currentNextDueISO, dueDay) {
      const base = currentNextDueISO ? parseISO(currentNextDueISO) : new Date();
      const y = base.getFullYear();
      const m = base.getMonth();
      const next = dueDateForMonth(y, m+1, dueDay);
      return toISODate(next);
    }
    function fmtMoney(value, cur) {
      try { return new Intl.NumberFormat("en-US",{style:"currency",currency:cur}).format(Number(value||0)); }
      catch { return "$"+Number(value||0).toFixed(2); }
    }
    function escapeHtml(str){
      return (str??"").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // ======= SETTINGS (localStorage simple) =======
    const getSetting = (key, fallback)=> {
      try {
        const v = localStorage.getItem("fabre_"+key);
        return v === null ? fallback : JSON.parse(v);
      } catch { return fallback; }
    };
    const setSetting = (key, value)=> {
      localStorage.setItem("fabre_"+key, JSON.stringify(value));
    };

    // ======= SUPABASE PING + CONN BADGE =======
    async function sbPing() {
      const { error } = await supabase.from(SB_TABLE_BILLS).select("id").limit(1);
      if (error) throw error;
    }

    async function verificarConexionSupabase() {
      const box = $("dbConnStatus");
      if (!box) return;
      try {
        await sbPing();
        const hora = new Date().toLocaleTimeString("es-US", { hour: "2-digit", minute: "2-digit" });
        box.textContent = `üü¢ Conectado ‚Äî ${hora}`;
        box.style.background = "#043";
        box.style.borderColor = "#0f5";
      } catch (e) {
        console.error("Supabase error:", e);
        box.textContent = "üî¥ Sin conexi√≥n / sin permisos (RLS)";
        box.style.background = "#400";
        box.style.borderColor = "#f55";
      }
    }

    // ======= CRUD =======
    async function putBill(bill) {
      await sbPing();
      const { error } = await supabase.from(SB_TABLE_BILLS).upsert(bill, { onConflict: "id" });
      if (error) throw error;
      return true;
    }
    async function listBills() {
      await sbPing();
      const { data, error } = await supabase.from(SB_TABLE_BILLS).select("*");
      if (error) throw error;
      return data || [];
    }
    async function deleteBill(billId) {
      await sbPing();
      await supabase.from(SB_TABLE_PAYMENTS).delete().eq("bill_id", billId);
      const { error } = await supabase.from(SB_TABLE_BILLS).delete().eq("id", billId);
      if (error) throw error;
      return true;
    }
    async function addPayment(payment) {
      await sbPing();
      const { error } = await supabase.from(SB_TABLE_PAYMENTS).upsert(payment, { onConflict: "id" });
      if (error) throw error;
      return true;
    }
    async function listPaymentsByBill(billId) {
      await sbPing();
      const { data, error } = await supabase.from(SB_TABLE_PAYMENTS).select("*").eq("bill_id", billId);
      if (error) throw error;
      return (data || []).sort((a,b)=> (a.pay_date > b.pay_date ? -1 : 1));
    }
    async function deletePayment(paymentId) {
      await sbPing();
      const { error } = await supabase.from(SB_TABLE_PAYMENTS).delete().eq("id", paymentId);
      if (error) throw error;
      return true;
    }

    // ======= APP STATE =======
    let cache = { bills: [], currency:"USD", defaultRemindDays:7 };
    let editingId = null;
    let payingBillId = null;
    let histBillId = null;
    let lastFocusTarget = "form";

    // ======= DROPDOWNS =======
    function buildDueDayOptions() {
      const sel = $("dueDay");
      if(!sel) return;
      sel.innerHTML = "";
      for (let i=1;i<=31;i++) {
        const opt=document.createElement("option");
        opt.value=String(i);
        opt.textContent=`D√≠a ${i}`;
        sel.appendChild(opt);
      }
    }

    function getNameLibrary() {
      return getSetting("billNameLibrary", []);
    }
    function setNameLibrary(names) {
      const uniq = Array.from(new Set((names||[]).map(x=>String(x||"").trim()).filter(Boolean)));
      uniq.sort((a,b)=>a.localeCompare(b));
      setSetting("billNameLibrary", uniq);
      return uniq;
    }

    async function rebuildBillNameCombo(selectedValue = "") {
      const lib = getNameLibrary();
      const dbNames = (cache.bills || []).map(b=>b.name).filter(Boolean);
      const all = setNameLibrary([...lib, ...dbNames]);

      const sel = $("billNameSelect");
      if(!sel) return;
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecciona un bill‚Ä¶";
      sel.appendChild(opt0);

      for (const n of all) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      }
      sel.value = selectedValue || "";
    }

    function rebuildPayBillSelect(selectedId = "") {
      const sel = $("payBillSelect");
      if(!sel) return;
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecciona un bill‚Ä¶";
      sel.appendChild(opt0);

      for (const b of cache.bills) {
        const opt = document.createElement("option");
        opt.value = b.id;
        const due = b.next_due_date ? ` | Pr√≥ximo: ${b.next_due_date}` : "";
        opt.textContent = `${b.name}${due}`;
        sel.appendChild(opt);
      }
      sel.value = selectedId || "";
    }

    // ======= NOTIFICATIONS (b√°sico) =======
    async function enableNotifications() {
      if (!("Notification" in window)) return toast("Este navegador no soporta notificaciones");
      const perm = await Notification.requestPermission();
      if (perm === "granted") toast("Notificaciones activadas");
      else toast("Notificaciones bloqueadas");
    }
    function showNotification(title, body) {
      try {
        if (!("Notification" in window)) return;
        if (Notification.permission !== "granted") return;
        new Notification(title, { body });
      } catch {}
    }
    async function notifyDueBillsWhileOpen() {
      const remindDays = Number(getSetting("defaultRemindDays", 7));
      const today = todayISO();

      for (const b of cache.bills) {
        if (!b.next_due_date) continue;
        const daysLeft = daysBetween(today, b.next_due_date);
        const overdue = daysLeft < 0;
        const soon = daysLeft >= 0 && daysLeft <= remindDays;
        if (!overdue && !soon) continue;

        const lastN = b.last_notified_date || null;
        if (lastN === today) continue;

        const statusTxt = overdue ? `VENCIDO hace ${Math.abs(daysLeft)} d√≠a(s)` : `Vence en ${daysLeft} d√≠a(s)`;
        showNotification("Bill: " + b.name, `${statusTxt} ‚Äî Vence: ${b.next_due_date} ‚Äî Monto: ${fmtMoney(b.amount_monthly, cache.currency)}`);

        b.last_notified_date = today;
        await putBill(b);
      }
    }

    // ======= RENDER =======
    function statusForBill(b, remindDays, today) {
      const daysLeft = daysBetween(today, b.next_due_date);
      if (daysLeft < 0) return { key:"overdue", label:`Vencido (${Math.abs(daysLeft)}d)`, daysLeft };
      if (daysLeft <= remindDays) return { key:"soon", label:`Por vencer (${daysLeft}d)`, daysLeft };
      return { key:"ok", label:`Al d√≠a (${daysLeft}d)`, daysLeft };
    }

    function render() {
      const today = todayISO();
      const remindDays = Number($("remindDays")?.value || cache.defaultRemindDays);
      const filter = $("filter")?.value || "all";
      const q = ($("search")?.value || "").trim().toLowerCase();

      const totalMonthly = cache.bills.reduce((s,b)=> s + Number(b.amount_monthly||0), 0);
      let cOver=0, cSoon=0, cOk=0;

      for (const b of cache.bills) {
        if(!b.next_due_date) continue;
        const st = statusForBill(b, remindDays, today);
        if (st.key==="overdue") cOver++;
        else if (st.key==="soon") cSoon++;
        else cOk++;
      }

      if($("kTotalMonthly")) $("kTotalMonthly").textContent = fmtMoney(totalMonthly, cache.currency);
      if($("kOverdue")) $("kOverdue").textContent = String(cOver);
      if($("kSoon")) $("kSoon").textContent = String(cSoon);
      if($("kOk")) $("kOk").textContent = String(cOk);
      if($("kOverdueSub")) $("kOverdueSub").textContent = cOver ? "Tienes bills vencidos" : "‚Äî";
      if($("kSoonSub")) $("kSoonSub").textContent = cSoon ? `Vencen en <= ${remindDays} d√≠as` : "‚Äî";

      const bannerParts = [];
      if (cOver) bannerParts.push(`‚ö†Ô∏è ${cOver} vencido(s)`);
      if (cSoon) bannerParts.push(`‚è≥ ${cSoon} por vencer`);
      if (!bannerParts.length) bannerParts.push("‚úÖ Todo al d√≠a");
      if($("bannerText")) $("bannerText").textContent = bannerParts.join(" | ");

      const items = cache.bills.filter(b=>{
        if(!b.next_due_date) return true;
        const st = statusForBill(b, remindDays, today);
        if (filter !== "all" && st.key !== filter) return false;
        if (q) {
          const blob = `${b.name||""} ${b.category||""} ${b.vendor||""}`.toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });

      const tb = $("tbody");
      if(!tb) return;
      tb.innerHTML = "";

      for (const b of items) {
        const st = b.next_due_date ? statusForBill(b, remindDays, today) : { key:"ok", label:"‚Äî", daysLeft: 999 };
        const pillClass = st.key==="overdue" ? "pill overdue" : st.key==="soon" ? "pill soon" : "pill ok";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="${pillClass}">${escapeHtml(st.label)}</span></td>
          <td>
            <div><b>${escapeHtml(b.name)}</b></div>
            <div class="muted">${escapeHtml(b.category||"")}</div>
          </td>
          <td class="mono">${escapeHtml(b.due_day ? ("D√≠a " + b.due_day) : "")}</td>
          <td class="mono">${fmtMoney(b.amount_monthly, cache.currency)}</td>
          <td class="mono">${escapeHtml(b.last_paid_date || "‚Äî")}</td>
          <td class="mono"><b>${escapeHtml(b.next_due_date || "‚Äî")}</b></td>
          <td>${escapeHtml(b.method || "")}</td>
          <td>${escapeHtml(b.vendor || "")}</td>
          <td>
            <div class="actions">
              <button class="ok" data-pay="${b.id}" type="button">Pagar</button>
              <button data-hist="${b.id}" type="button">Historial</button>
              <button data-edit="${b.id}" type="button">Editar</button>
              <button class="danger" data-del="${b.id}" type="button">Borrar</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-pay]").forEach(btn=>{
        btn.onclick = () => beginPay(btn.getAttribute("data-pay"));
      });
      tb.querySelectorAll("button[data-hist]").forEach(btn=>{
        btn.onclick = () => openHistory(btn.getAttribute("data-hist"));
      });
      tb.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.onclick = () => beginEdit(btn.getAttribute("data-edit"));
      });
      tb.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-del");
          if (!confirm("¬øBorrar este bill y su historial de pagos?")) return;
          await deleteBill(id);
          toast("Borrado");
          if (payingBillId === id) resetPayBox();
          if (editingId === id) clearForm();
          if (histBillId === id) closeHistory();
          await refresh();
        };
      });
    }

    async function refresh() {
      cache.currency = getSetting("currency","USD");
      cache.defaultRemindDays = Number(getSetting("defaultRemindDays", 7));
      if($("currency")) $("currency").value = cache.currency;
      if($("currencyLabel")) $("currencyLabel").textContent = cache.currency;
      if($("remindDays")) $("remindDays").value = String(cache.defaultRemindDays);

      cache.bills = await listBills();
      cache.bills.sort((a,b)=> (String(a.next_due_date||"") > String(b.next_due_date||"") ? 1 : -1));

      await rebuildBillNameCombo($("billNameSelect")?.value || "");
      rebuildPayBillSelect($("payBillSelect")?.value || "");

      render();
      await notifyDueBillsWhileOpen();
    }

    // ======= FORM =======
    function clearForm() {
      editingId = null;
      if($("editId")) $("editId").textContent = "Nuevo";
      if($("billNameSelect")) $("billNameSelect").value = "";
      if($("amount")) $("amount").value = "";
      if($("dueDay")) $("dueDay").value = "1";
      if($("category")) $("category").value = "";
      if($("vendor")) $("vendor").value = "";
      if($("method")) $("method").value = "Cash";
      if($("formHint")) $("formHint").textContent = "‚Äî";
    }

    function beginEdit(billId) {
      const b = cache.bills.find(x=>x.id===billId);
      if (!b) return;
      editingId = billId;
      if($("editId")) $("editId").textContent = billId;
      if($("billNameSelect")) $("billNameSelect").value = b.name || "";
      if($("amount")) $("amount").value = b.amount_monthly ?? "";
      if($("dueDay")) $("dueDay").value = String(b.due_day ?? 1);
      if($("category")) $("category").value = b.category || "";
      if($("vendor")) $("vendor").value = b.vendor || "";
      if($("method")) $("method").value = b.method || "Cash";
      if($("formHint")) $("formHint").textContent = "Editando. Guarda para aplicar cambios.";
      toast("Modo edici√≥n");
    }

    function resetPayBox() {
      payingBillId = null;
      if($("payBillName")) $("payBillName").textContent = "‚Äî";
      if($("payBillSelect")) $("payBillSelect").value = "";
      if($("payDate")) $("payDate").value = todayISO();
      if($("payAmount")) $("payAmount").value = "";
      if($("payNote")) $("payNote").value = "";
      if($("btnConfirmPay")) $("btnConfirmPay").disabled = true;
    }
    function setPayFromBill(b) {
      payingBillId = b.id;
      if($("payBillName")) $("payBillName").textContent = b.name;
      if($("payDate")) $("payDate").value = todayISO();
      if($("payAmount")) $("payAmount").value = String(b.amount_monthly ?? "");
      if($("payNote")) $("payNote").value = "";
      if($("btnConfirmPay")) $("btnConfirmPay").disabled = false;
    }
    function beginPay(billId) {
      const b = cache.bills.find(x=>x.id===billId);
      if (!b) return;
      if($("payBillSelect")) $("payBillSelect").value = billId;
      setPayFromBill(b);
      toast("Listo para marcar pagado");
    }

    // ======= HISTORY MODAL =======
    function openModal() { $("modalBack")?.classList.add("show"); }
    function closeModal() { $("modalBack")?.classList.remove("show"); }

    async function renderHistory() {
      if (!histBillId) return;
      const pays = await listPaymentsByBill(histBillId);
      const total = pays.reduce((s,p)=>s + Number(p.amount_paid||0), 0);

      if($("histTotal")) $("histTotal").textContent = fmtMoney(total, cache.currency);
      if($("histCount")) $("histCount").textContent = String(pays.length);

      const tb = $("histBody");
      if(!tb) return;
      tb.innerHTML = "";
      for (const p of pays) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(p.pay_date)}</td>
          <td class="mono">${fmtMoney(p.amount_paid, cache.currency)}</td>
          <td>${escapeHtml(p.note || "")}</td>
          <td><button class="danger" data-delpay="${p.id}" type="button">Borrar</button></td>
        `;
        tb.appendChild(tr);
      }

      tb.querySelectorAll("button[data-delpay]").forEach(btn=>{
        btn.onclick = async ()=>{
          const pid = btn.getAttribute("data-delpay");
          if (!confirm("¬øBorrar este pago del historial?")) return;
          await deletePayment(pid);
          toast("Pago borrado");
          await renderHistory();
        };
      });
    }

    async function openHistory(billId) {
      const b = cache.bills.find(x=>x.id===billId);
      if (!b) return;

      histBillId = billId;
      if($("histTitle")) $("histTitle").textContent = `${b.name} | Monto mensual: ${fmtMoney(b.amount_monthly, cache.currency)} | Pr√≥ximo: ${b.next_due_date || "‚Äî"}`;
      await renderHistory();
      openModal();
    }
    function closeHistory() {
      histBillId = null;
      if($("histBody")) $("histBody").innerHTML = "";
      closeModal();
    }

    // ======= CSV =======
    function downloadFile(filename, content, mime="application/octet-stream") {
      const blob = new Blob([content],{type:mime});
      const url = URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ======= MODAL NOMBRE BILL =======
    function openBillNameModal(target="form") {
      lastFocusTarget = target;
      if($("billNameNew")) $("billNameNew").value = "";
      if($("billNameHint")) $("billNameHint").textContent = "‚Äî";
      $("billNameModalBack")?.classList.add("show");
      setTimeout(()=> $("billNameNew")?.focus(), 60);
    }
    function closeBillNameModal() {
      $("billNameModalBack")?.classList.remove("show");
    }

    // ======= BOOT =======
    function bindEvents() {
      // Basic guards
      const billForm = $("billForm");
      if (billForm) {
        billForm.onsubmit = async (ev)=>{
          ev.preventDefault();

          const name = ($("billNameSelect")?.value || "").trim();
          const amount = Number($("amount")?.value);
          const dueDay = Number($("dueDay")?.value);

          if (!name) return toast("Selecciona (o agrega) el nombre del bill");
          if (!Number.isFinite(amount) || amount <= 0) return toast("Monto inv√°lido");
          if (!Number.isFinite(dueDay) || dueDay < 1 || dueDay > 31) return toast("D√≠a de vencimiento inv√°lido");

          const currency = $("currency")?.value || "USD";
          setSetting("currency", currency);
          cache.currency = currency;
          if($("currencyLabel")) $("currencyLabel").textContent = currency;

          const lib = getNameLibrary();
          setNameLibrary([...lib, name]);

          const bill = editingId ? (cache.bills.find(x=>x.id===editingId) || { id: editingId }) : { id: uid() };
          bill.name = name;
          bill.amount_monthly = Number(amount.toFixed(2));
          bill.due_day = dueDay;
          bill.category = ($("category")?.value || "").trim() || null;
          bill.vendor = ($("vendor")?.value || "").trim() || null;
          bill.method = $("method")?.value || "Cash";

          if (!bill.next_due_date) bill.next_due_date = computeInitialNextDue(dueDay);

          await putBill(bill);
          toast(editingId ? "Bill actualizado" : "Bill creado");
          clearForm();
          await refresh();
        };
      }

      $("btnClear")?.addEventListener("click", ()=>{ clearForm(); toast("Formulario limpio"); });

      $("btnPayLoad")?.addEventListener("click", ()=>{
        const id = $("payBillSelect")?.value;
        const b = cache.bills.find(x=>x.id===id);
        if (!b) return toast("Selecciona un bill");
        setPayFromBill(b);
        toast("Bill cargado");
      });

      $("payBillSelect")?.addEventListener("change", ()=>{
        const id = $("payBillSelect")?.value;
        if (!id) return resetPayBox();
        const b = cache.bills.find(x=>x.id===id);
        if (!b) return resetPayBox();
        setPayFromBill(b);
      });

      $("btnConfirmPay")?.addEventListener("click", async ()=>{
        if (!payingBillId) return;
        const b = cache.bills.find(x=>x.id===payingBillId);
        if (!b) return;

        const payDate = $("payDate")?.value || todayISO();
        const payAmount = Number($("payAmount")?.value);
        if (!Number.isFinite(payAmount) || payAmount <= 0) return toast("Monto pagado inv√°lido");

        const payment = {
          id: uid(),
          bill_id: b.id,
          bill_name: b.name,
          pay_date: payDate,
          amount_paid: Number(payAmount.toFixed(2)),
          note: ($("payNote")?.value || "").trim() || null,
          created_at: new Date().toISOString()
        };
        await addPayment(payment);

        b.last_paid_date = payDate;
        b.last_paid_amount = Number(payAmount.toFixed(2));
        b.next_due_date = computeNextDueAfterPay(b.next_due_date, b.due_day);
        b.last_notified_date = null;
        await putBill(b);

        toast(`Pagado. Pr√≥ximo: ${b.next_due_date}`);
        resetPayBox();
        await refresh();
      });

      $("btnHistClose")?.addEventListener("click", closeHistory);
      $("modalBack")?.addEventListener("click", (e)=>{ if (e.target === $("modalBack")) closeHistory(); });

      $("btnHistCSV")?.addEventListener("click", async ()=>{
        if (!histBillId) return;
        const b = cache.bills.find(x=>x.id===histBillId);
        const pays = await listPaymentsByBill(histBillId);
        const headers = ["bill","pay_date","amount_paid","note","currency"];
        const rows = [headers.join(",")];
        for (const p of pays.slice().reverse()) {
          rows.push([
            `"${(b?.name||"").replaceAll('"','""')}"`,
            p.pay_date,
            Number(p.amount_paid||0).toFixed(2),
            `"${(p.note||"").replaceAll('"','""')}"`,
            cache.currency
          ].join(","));
        }
        downloadFile(`historial_${(b?.name||"bill").replaceAll(" ","_")}.csv`, rows.join("\n"), "text/csv");
        toast("CSV del historial exportado");
      });

      // Bill name modal
      $("btnAddBillName")?.addEventListener("click", ()=>openBillNameModal("form"));
      $("btnPayAddBill")?.addEventListener("click", ()=>openBillNameModal("pay"));
      $("btnBillNameClose")?.addEventListener("click", closeBillNameModal);
      $("billNameModalBack")?.addEventListener("click", (e)=>{ if (e.target === $("billNameModalBack")) closeBillNameModal(); });

      $("btnBillNameSave")?.addEventListener("click", ()=>{
        const n = ($("billNameNew")?.value || "").trim();
        if (!n) { if($("billNameHint")) $("billNameHint").textContent = "Escribe un nombre."; return; }
        const lib = getNameLibrary();
        setNameLibrary([...lib, n]);
        rebuildBillNameCombo(n);
        if($("billNameHint")) $("billNameHint").textContent = "Guardado ‚úÖ";
        toast("Nombre agregado. Ahora completa monto/vencimiento y guarda el bill.");
        closeBillNameModal();
        if (lastFocusTarget === "pay") {
          resetPayBox();
          $("amount")?.focus();
        }
      });

      // Filters/search/refresh
      $("remindDays")?.addEventListener("change", async ()=>{
        const v = Number($("remindDays")?.value);
        setSetting("defaultRemindDays", v);
        toast("Aviso actualizado");
        await refresh();
      });
      $("filter")?.addEventListener("change", render);
      $("search")?.addEventListener("input", render);
      $("btnRefresh")?.addEventListener("click", ()=>refresh().then(()=>toast("Actualizado")).catch(()=>toast("Error")));

      // Notif buttons
      $("btnNotif")?.addEventListener("click", enableNotifications);
      $("btnInstallTips")?.addEventListener("click", ()=>toast("Para notificaciones con app cerrada: instala como PWA (Chrome > Install app)."));

      // Programar alertas (solo mientras abierta en esta versi√≥n simple)
      $("btnSchedule")?.addEventListener("click", async ()=>{
        await enableNotifications();
        toast("Listo. La app avisar√° mientras est√© abierta.");
      });
    }

    // Expose for table buttons
    window.beginPay = beginPay;
    window.beginEdit = beginEdit;
    window.openHistory = openHistory;
    window.closeHistory = closeHistory;

    // ======= INIT =======
    document.addEventListener("DOMContentLoaded", async ()=>{
      // defaults
      if (getSetting("currency", null) === null) setSetting("currency","USD");
      if (getSetting("defaultRemindDays", null) === null) setSetting("defaultRemindDays", 7);
      if (!Array.isArray(getSetting("billNameLibrary", null))) setSetting("billNameLibrary", []);

      buildDueDayOptions();
      if($("dueDay")) $("dueDay").value = "1";

      bindEvents();
      $("payDate") && ($("payDate").value = todayISO());

      await verificarConexionSupabase();
      setInterval(verificarConexionSupabase, 15000);

      await refresh();
      clearForm();
      resetPayBox();

      setInterval(()=>{ notifyDueBillsWhileOpen().catch(()=>{}); }, 60*1000);
    });
  </script>
</body>
</html>





