<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#080f1e"/>
  <title>Finance Control</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Cabinet+Grotesk:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#080f1e;--surface:#0e1829;--card:#111f35;
      --muted:#7a8fae;--text:#dce8ff;--line:rgba(100,140,200,.12);
      --accent:#3d9fff;--accent2:#00d4a8;--danger:#ff4060;--warn:#ffb830;--ok:#00d4a8;
      --shadow:0 8px 32px rgba(0,0,0,.45);--r:14px;--r2:20px;
      --mono:'DM Mono',ui-monospace,Menlo,monospace;
      --sans:'Cabinet Grotesk',system-ui,sans-serif
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--sans);color:var(--text);background:var(--bg);min-height:100vh}
    body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(ellipse 80% 50% at 20% 20%,rgba(61,159,255,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 80% 80%,rgba(0,212,168,.05) 0%,transparent 60%);pointer-events:none;z-index:0}
    .wrap{max-width:1360px;margin:0 auto;padding:20px;position:relative;z-index:1}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:20px;padding:14px 20px;background:rgba(14,24,41,.8);border:1px solid var(--line);border-radius:var(--r2);backdrop-filter:blur(12px)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:18px}
    .brand-name{font-size:18px;font-weight:900;letter-spacing:-.5px}
    .brand-sub{font-size:11px;color:var(--muted);margin-top:1px}
    .topbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .conn-badge{display:flex;align-items:center;gap:7px;padding:7px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:12px;font-family:var(--mono);cursor:pointer;transition:.15s}
    .conn-badge:hover{background:rgba(255,255,255,.06)}
    .conn-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .conn-badge.ok .conn-dot{background:var(--ok);box-shadow:0 0 6px var(--ok)}
    .conn-badge.err .conn-dot{background:var(--danger)}
    .conn-badge.checking .conn-dot{background:var(--warn);animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
    button{cursor:pointer;font-family:var(--sans);font-size:13px;font-weight:600;padding:9px 14px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--text);transition:.12s ease;outline:none}
    button:hover{background:rgba(255,255,255,.10);transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .btn-primary{background:rgba(61,159,255,.2);border-color:rgba(61,159,255,.4);color:#7cc4ff}
    .btn-ok{background:rgba(0,212,168,.15);border-color:rgba(0,212,168,.35);color:#00d4a8}
    .btn-danger{background:rgba(255,64,96,.15);border-color:rgba(255,64,96,.35);color:#ff6080}
    .btn-warn{background:rgba(255,184,48,.12);border-color:rgba(255,184,48,.3);color:#ffb830}
    .btn-icon{width:36px;height:36px;padding:0;display:inline-flex;align-items:center;justify-content:center;font-size:16px;border-radius:10px}
    input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:rgba(0,0,0,.3);color:var(--text);font-family:var(--sans);font-size:13px;outline:none;transition:.12s}
    input:focus,select:focus{border-color:rgba(61,159,255,.4);background:rgba(0,0,0,.4)}
    input.valid{border-color:rgba(0,212,168,.4)}
    input.invalid{border-color:rgba(255,64,96,.35)}
    .nav-tabs{display:flex;gap:4px;padding:4px;background:rgba(0,0,0,.3);border:1px solid var(--line);border-radius:var(--r2);margin-bottom:20px;flex-wrap:wrap}
    .nav-tab{flex:1;min-width:120px;padding:10px 16px;border-radius:12px;border:none;background:transparent;color:var(--muted);font-size:13px;font-weight:700;transition:.15s;letter-spacing:.2px}
    .nav-tab:hover{background:rgba(255,255,255,.06);color:var(--text);transform:none}
    .nav-tab.active{background:rgba(61,159,255,.18);color:var(--accent);border:1px solid rgba(61,159,255,.25)}
    .tab-pane{display:none}
    .tab-pane.active{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r2);box-shadow:var(--shadow);overflow:hidden}
    .card-hd{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .card-hd-title{font-size:14px;font-weight:700}
    .card-hd-sub{font-size:12px;color:var(--muted)}
    .card-bd{padding:18px}
    .card-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:800px){.card-grid{grid-template-columns:1fr}}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    @media(max-width:900px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    .kpi-grid-6{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    @media(min-width:1100px){.kpi-grid-6{grid-template-columns:repeat(6,1fr)}}
    .kpi{padding:16px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.2);position:relative;overflow:hidden}
    .kpi-label{font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase}
    .kpi-value{font-size:22px;font-weight:900;margin-top:6px;font-family:var(--mono);letter-spacing:-1px}
    .kpi-sub{font-size:11px;margin-top:4px;color:var(--muted)}
    .kpi.accent .kpi-value{color:var(--accent)}
    .kpi.ok .kpi-value{color:var(--ok)}
    .kpi.danger .kpi-value{color:var(--danger)}
    .kpi.warn .kpi-value{color:var(--warn)}
    .pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:999px;border:1px solid var(--line);font-size:11px;font-weight:600}
    .pill.overdue{border-color:rgba(255,64,96,.5);background:rgba(255,64,96,.1);color:#ff6080}
    .pill.soon{border-color:rgba(61,159,255,.5);background:rgba(61,159,255,.1);color:#7cc4ff}
    .pill.ok-p{border-color:rgba(0,212,168,.45);background:rgba(0,212,168,.09);color:#00d4a8}
    .pill.warn-p{border-color:rgba(255,184,48,.45);background:rgba(255,184,48,.09);color:#ffb830}
    .table-wrap{overflow-x:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:600px}
    th,td{padding:11px 12px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:middle}
    th{color:var(--muted);font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;position:sticky;top:0;background:rgba(11,20,37,.97)}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:rgba(255,255,255,.02)}
    .mono{font-family:var(--mono);font-size:12px}
    .actions-row{display:flex;gap:6px;flex-wrap:wrap}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.form-grid{grid-template-columns:1fr}}
    .form-full{grid-column:1/-1}
    .form-label{font-size:11px;color:var(--muted);margin-bottom:5px;font-weight:600;letter-spacing:.4px;text-transform:uppercase}
    .form-field{display:flex;flex-direction:column}
    .form-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .form-row>*{flex:1;min-width:160px}
    .prog-wrap{margin-top:6px}
    .prog-bar-bg{height:6px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
    .prog-bar{height:100%;border-radius:999px;transition:width .4s ease;min-width:2px}
    .prog-bar.ok{background:linear-gradient(90deg,var(--ok),#00a87e)}
    .prog-bar.warn{background:linear-gradient(90deg,var(--warn),#e69500)}
    .prog-bar.danger{background:linear-gradient(90deg,var(--danger),#c03050)}
    .prog-label{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:3px}
    .cc-item{padding:14px 16px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.2);transition:.15s}
    .cc-item:hover{background:rgba(255,255,255,.03);border-color:rgba(61,159,255,.2)}
    .cc-header{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:10px}
    .cc-name{font-weight:800;font-size:15px}
    .cc-bank{font-size:11px;color:var(--muted);margin-top:2px}
    .cc-amounts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
    .cc-amount-item{text-align:center;padding:8px;background:rgba(0,0,0,.2);border-radius:10px}
    .cc-amount-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .cc-amount-value{font-size:14px;font-weight:700;font-family:var(--mono);margin-top:3px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000;backdrop-filter:blur(4px)}
    .modal-back.show{display:flex}
    .modal{width:min(640px,100%);max-height:90vh;overflow-y:auto;background:#0e1829;border:1px solid rgba(100,140,200,.2);border-radius:var(--r2);box-shadow:0 24px 64px rgba(0,0,0,.6)}
    .modal.modal-lg{width:min(1000px,100%)}
    .modal .card-hd{position:sticky;top:0;background:#0e1829;z-index:2}
    .sb-field{margin-bottom:14px}
    .sb-field label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600;letter-spacing:.4px;text-transform:uppercase}
    .sb-field input{width:100%;font-family:var(--mono);font-size:12px}
    .key-preview{margin-top:5px;padding:6px 10px;border-radius:8px;font-family:var(--mono);font-size:11px;color:var(--muted);background:rgba(0,0,0,.3);border:1px solid var(--line);word-break:break-all}
    .conn-status-box{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:rgba(0,0,0,.3);font-family:var(--mono);font-size:13px}
    .csb-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
    .conn-status-box.ok-c .csb-dot{background:var(--ok);box-shadow:0 0 8px var(--ok)}
    .conn-status-box.err-c .csb-dot{background:var(--danger)}
    .conn-status-box.chk-c .csb-dot{background:var(--warn);animation:blink 1s infinite}
    .step-guide{margin-top:14px;padding:14px;border-radius:12px;background:rgba(61,159,255,.05);border:1px solid rgba(61,159,255,.15)}
    .step-guide h4{font-size:13px;color:var(--accent);margin-bottom:10px}
    .step-guide ol{padding-left:18px}
    .step-guide li{font-size:12px;color:var(--muted);margin-bottom:5px;line-height:1.7}
    .step-guide code{background:rgba(61,159,255,.12);padding:1px 6px;border-radius:5px;font-family:var(--mono);font-size:11px;color:var(--accent)}
    .divider{height:1px;background:var(--line);margin:16px 0}
    .section-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .section-title{font-size:16px;font-weight:800}
    .gap-8{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .text-muted{color:var(--muted)}
    .text-ok{color:var(--ok)}
    .text-danger{color:var(--danger)}
    .text-warn{color:var(--warn)}
    .text-accent{color:var(--accent)}
    .fw-900{font-weight:900}
    .toast{position:fixed;right:18px;bottom:18px;background:#0e1829;border:1px solid rgba(100,140,200,.25);border-radius:14px;padding:12px 16px;box-shadow:var(--shadow);display:none;max-width:400px;z-index:9999;font-size:13px}
    .toast.show{display:block}
    .plan-box{margin-top:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px;border:1px solid rgba(0,212,168,.15)}
    .plan-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:11px}
    .type-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 8px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.2);cursor:pointer;transition:.15s;font-size:12px;font-weight:700;color:var(--muted);text-align:center;user-select:none}
    .type-btn:hover{background:rgba(255,255,255,.06);color:var(--text)}
    .type-btn.active{background:rgba(61,159,255,.18);border-color:rgba(61,159,255,.4);color:var(--accent)}
  </style>
</head>
<body>
<div class="wrap">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-icon">&#x1F4B3;</div>
      <div>
        <div class="brand-name">Finance Control</div>
        <div class="brand-sub">Bills &middot; Cr&eacute;ditos &middot; Reportes</div>
      </div>
    </div>
    <div class="topbar-actions">
      <div class="conn-badge checking" id="connBadge" title="Configurar Supabase" onclick="openSupaModal()">
        <div class="conn-dot"></div>
        <span id="connBadgeText">Conectando&hellip;</span>
      </div>
      <button class="btn-warn" onclick="openSupaModal()">&#x2699;&#xFE0F; Supabase</button>
      <button class="btn-danger" id="btnReset">&#x1F5D1; Borrar DB Local</button>
    </div>
  </div>

  <!-- NAV TABS -->
  <div class="nav-tabs">
    <button class="nav-tab active" data-tab="tabDash">&#x1F4CA; Dashboard</button>
    <button class="nav-tab" data-tab="tabBills">&#x1F4CB; Bills</button>
    <button class="nav-tab" data-tab="tabCredit">&#x1F4B3; Cr&eacute;ditos</button>
    <button class="nav-tab" data-tab="tabReports">&#x1F4C8; Reportes</button>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div class="tab-pane active" id="tabDash">
    <div class="section-header">
      <div class="section-title">&#x1F4B8; Bills Mensuales</div>
      <div class="gap-8">
        <span class="text-muted" style="font-size:12px">Moneda: <b id="currencyLabel">USD</b></span>
        <select id="remindDays" style="padding:6px 10px;font-size:12px">
          <option value="3">Avisar 3d antes</option>
          <option value="5">Avisar 5d antes</option>
          <option value="7" selected>Avisar 7d antes</option>
          <option value="10">Avisar 10d antes</option>
          <option value="15">Avisar 15d antes</option>
        </select>
      </div>
    </div>
    <div class="kpi-grid">
      <div class="kpi accent"><div class="kpi-label">Total mensual</div><div class="kpi-value" id="kTotalMonthly">$0</div><div class="kpi-sub">Suma de bills</div></div>
      <div class="kpi danger"><div class="kpi-label">Vencidos</div><div class="kpi-value" id="kOverdue">0</div><div class="kpi-sub" id="kOverdueSub">--</div></div>
      <div class="kpi warn"><div class="kpi-label">Por vencer</div><div class="kpi-value" id="kSoon">0</div><div class="kpi-sub" id="kSoonSub">--</div></div>
      <div class="kpi ok"><div class="kpi-label">Al dia</div><div class="kpi-value" id="kOk">0</div><div class="kpi-sub">--</div></div>
    </div>
    <div class="card" style="margin-bottom:20px">
      <div class="card-hd"><div class="card-hd-title">&#x23F0; Proximos vencimientos</div><button class="btn-primary" onclick="switchTab('tabBills')">Ver todos &rarr;</button></div>
      <div class="card-bd" style="padding:0">
        <div class="table-wrap"><table>
          <thead><tr><th>Estado</th><th>Bill</th><th>Vence</th><th>Monto</th><th>Accion</th></tr></thead>
          <tbody id="dashBillsBody"></tbody>
        </table></div>
      </div>
    </div>
    <div class="section-header" style="margin-top:24px">
      <div class="section-title">&#x1F4B3; Cuentas a Credito</div>
      <button class="btn-primary" onclick="switchTab('tabCredit')">Gestionar &rarr;</button>
    </div>
    <div class="kpi-grid-6">
      <div class="kpi accent"><div class="kpi-label">Deuda total</div><div class="kpi-value" id="kCreditTotal">$0</div><div class="kpi-sub">Saldos pendientes</div></div>
      <div class="kpi danger"><div class="kpi-label">Limite total</div><div class="kpi-value" id="kCreditLimit">$0</div><div class="kpi-sub">Combinado</div></div>
      <div class="kpi warn"><div class="kpi-label">Uso credito</div><div class="kpi-value" id="kCreditUtil">0%</div><div class="kpi-sub">Ideal &lt;30%</div></div>
      <div class="kpi ok"><div class="kpi-label">Pagado (mes)</div><div class="kpi-value" id="kCreditPaidMonth">$0</div><div class="kpi-sub">Este mes</div></div>
      <div class="kpi"><div class="kpi-label">APR promedio</div><div class="kpi-value" id="kCreditAPR" style="color:var(--warn)">0%</div><div class="kpi-sub">Interes anual</div></div>
      <div class="kpi"><div class="kpi-label">Cuentas</div><div class="kpi-value" id="kCreditCount">0</div><div class="kpi-sub">Activas</div></div>
    </div>
    <div class="card">
      <div class="card-hd"><div class="card-hd-title">&#x1F4CA; Resumen de creditos</div></div>
      <div class="card-bd"><div id="dashCreditList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px"><div class="text-muted" style="font-size:13px">Sin cuentas de credito.</div></div></div>
    </div>
  </div>

  <!-- ===== BILLS ===== -->
  <div class="tab-pane" id="tabBills">
    <div class="card-grid" style="margin-bottom:16px">
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x2795; Agregar / Editar bill</div><span class="text-muted mono" id="editId" style="font-size:11px">Nuevo</span></div>
        <div class="card-bd">
          <form id="billForm" class="form-grid">
            <div class="form-full">
              <div class="form-label">Nombre del bill</div>
              <div class="form-row"><select id="billNameSelect" required></select><button type="button" class="btn-ok btn-icon" id="btnAddBillName">+</button></div>
            </div>
            <div class="form-field"><div class="form-label">Monto mensual</div><input id="amount" type="number" step="0.01" min="0" placeholder="120.50" required></div>
            <div class="form-field"><div class="form-label">Dia de vencimiento</div><select id="dueDay" required></select></div>
            <div class="form-field"><div class="form-label">Metodo de pago</div><select id="method"><option>Cash</option><option>Card</option><option>Transfer</option><option>Zelle</option><option>Check</option><option>AutoPay</option></select></div>
            <div class="form-field"><div class="form-label">Moneda</div><select id="currency"><option value="USD">USD</option><option value="EUR">EUR</option><option value="DOP">DOP</option><option value="MXN">MXN</option></select></div>
            <div class="form-field"><div class="form-label">Categoria (opcional)</div><input id="category" type="text" placeholder="Utilities, Rent..." maxlength="40"></div>
            <div class="form-field"><div class="form-label">Proveedor (opcional)</div><input id="vendor" type="text" placeholder="FPL, AT&amp;T..." maxlength="60"></div>
            <div class="form-full"><div class="form-label">&#x1F517; Link de pago (opcional)</div><div style="display:flex;gap:8px;align-items:center"><input id="payUrl" type="url" placeholder="https://myprovider.com/pay" maxlength="500" style="flex:1"><button type="button" id="btnTestUrl" class="btn-primary" style="white-space:nowrap;padding:9px 12px;font-size:12px">&#x1F517; Abrir</button></div></div>
            <div class="form-full gap-8">
              <button type="submit" class="btn-primary">&#x1F4BE; Guardar bill</button>
              <button type="button" id="btnClear">&#x2715; Limpiar</button>
              <span class="text-muted" id="formHint" style="font-size:12px">--</span>
            </div>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x1F4B8; Marcar pagado</div><span class="text-muted" id="payBillName" style="font-size:12px">--</span></div>
        <div class="card-bd">
          <div class="form-field" style="margin-bottom:12px">
            <div class="form-label">Seleccionar bill</div>
            <div class="form-row"><select id="payBillSelect"></select><button type="button" class="btn-ok btn-icon" id="btnPayAddBill">+</button><button type="button" class="btn-ok" id="btnPayLoad">Cargar</button></div>
          </div>
          <div class="form-grid" style="margin-bottom:12px">
            <div class="form-field"><div class="form-label">Fecha de pago</div><input id="payDate" type="date"></div>
            <div class="form-field"><div class="form-label">Monto pagado</div><input id="payAmount" type="number" step="0.01" min="0"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px"><input id="payNote" type="text" placeholder="Nota (opcional)" maxlength="120"></div>
          <button class="btn-ok" id="btnConfirmPay" disabled style="width:100%">&#x2705; Confirmar pago</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">
        <div class="card-hd-title">&#x1F4CB; Todos los bills</div>
        <div class="gap-8">
          <select id="filter" style="font-size:12px;padding:6px 10px"><option value="all">Todos</option><option value="overdue">Vencidos</option><option value="soon">Por vencer</option><option value="ok">Al dia</option></select>
          <input id="search" type="text" placeholder="Buscar..." style="min-width:200px;padding:7px 11px;font-size:12px">
          <button id="btnRefresh" class="btn-primary">&#x21BB; Actualizar</button>
        </div>
      </div>
      <div class="card-bd" style="padding:0">
        <div class="table-wrap"><table>
          <thead><tr><th>Estado</th><th>Bill</th><th>Dia vence</th><th>Monto</th><th>Ultimo pago</th><th>Proximo</th><th>Metodo</th><th>Acciones</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table></div>
      </div>
    </div>
  </div>

  <!-- ===== CREDITOS ===== -->
  <div class="tab-pane" id="tabCredit">
    <div class="card-grid" style="margin-bottom:16px">
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x2795; Nueva cuenta de credito</div><span class="text-muted mono" id="creditEditId" style="font-size:11px">Nueva</span></div>
        <div class="card-bd">
          <form id="creditForm" class="form-grid">

            <!-- TIPO DE CUENTA -->
            <div class="form-full">
              <div class="form-label">Tipo de cuenta</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px">
                <label class="type-btn active" id="typeBtnCard" onclick="setAccType('card')">
                  <span style="font-size:20px">&#x1F4B3;</span>
                  <span>Tarjeta</span>
                </label>
                <label class="type-btn" id="typeBtnLoan" onclick="setAccType('loan')">
                  <span style="font-size:20px">&#x1F3E6;</span>
                  <span>Prestamo</span>
                </label>
                <label class="type-btn" id="typeBtnService" onclick="setAccType('service')">
                  <span style="font-size:20px">&#x1F527;</span>
                  <span>Repuesto / Servicio</span>
                </label>
              </div>
              <input type="hidden" id="ccAccountType" value="card">
            </div>

            <!-- CAMPOS COMUNES -->
            <div class="form-field form-full"><div class="form-label">Nombre de la cuenta</div><input id="ccName" type="text" placeholder="Visa Gold / Prestamo Auto / Taller Lopez..." maxlength="60" required></div>

            <!-- CAMPOS TARJETA / PRESTAMO -->
            <div id="ccFieldsCardLoan" class="form-full">
              <div class="form-grid">
                <div class="form-field"><div class="form-label">Banco / Emisor</div><input id="ccBank" type="text" placeholder="Chase, BofA, Citi..." maxlength="60"></div>
                <div class="form-field"><div class="form-label">Ultimos 4 digitos</div><input id="ccLast4" type="text" placeholder="1234" maxlength="4"></div>
                <div class="form-field"><div class="form-label">Limite de credito</div><input id="ccLimit" type="number" step="0.01" min="0" placeholder="5000.00"></div>
                <div class="form-field"><div class="form-label">Saldo actual (deuda)</div><input id="ccBalance" type="number" step="0.01" min="0" placeholder="1200.00"></div>
                <div class="form-field"><div class="form-label">APR / Interes anual (%)</div><input id="ccApr" type="number" step="0.01" min="0" max="100" placeholder="24.99"></div>
                <div class="form-field"><div class="form-label">Pago minimo mensual</div><input id="ccMinPayment" type="number" step="0.01" min="0" placeholder="35.00"></div>
                <div class="form-field"><div class="form-label">Dia de corte</div><select id="ccCutDay"></select></div>
                <div class="form-field"><div class="form-label">Dia de pago</div><select id="ccPayDay"></select></div>
              </div>
              <div class="divider"></div>
              <div class="form-label" style="margin-bottom:10px">&#x1F4C5; Plan de pago (opcional)</div>
              <div class="form-grid">
                <div class="form-field"><div class="form-label">Monto mensual del plan</div><input id="ccPlanAmount" type="number" step="0.01" min="0" placeholder="200.00"></div>
                <div class="form-field"><div class="form-label">Meses del plan</div><input id="ccPlanMonths" type="number" min="1" max="360" placeholder="12"></div>
              </div>
            </div>

            <!-- CAMPOS REPUESTO / SERVICIO -->
            <div id="ccFieldsService" class="form-full" style="display:none">
              <div class="form-grid">
                <div class="form-field"><div class="form-label">Nombre del comerciante</div><input id="ccMerchant" type="text" placeholder="Taller Lopez, Autopartes XYZ..." maxlength="80"></div>
                <div class="form-field"><div class="form-label">Tipo de servicio / repuesto</div><input id="ccServiceType" type="text" placeholder="Motor, Frenos, Electricidad..." maxlength="80"></div>
                <div class="form-field"><div class="form-label">Cantidad adeudada</div><input id="ccBalanceService" type="number" step="0.01" min="0" placeholder="850.00"></div>
                <div class="form-field"><div class="form-label">Fecha de la deuda</div><input id="ccDebtDate" type="date"></div>
                <div class="form-field"><div class="form-label">Telefono del comerciante</div><input id="ccPhone" type="tel" placeholder="(555) 123-4567" maxlength="20"></div>
              </div>
            </div>

            <!-- MONEDA Y NOTAS (siempre visibles) -->
            <div class="form-field"><div class="form-label">Moneda</div><select id="ccCurrency"><option value="USD">USD</option><option value="EUR">EUR</option><option value="DOP">DOP</option><option value="MXN">MXN</option></select></div>
            <div class="form-field"><div class="form-label">Notas</div><input id="ccNotes" type="text" placeholder="Observaciones..." maxlength="120"></div>

            <div class="form-full gap-8">
              <button type="submit" class="btn-primary">&#x1F4BE; Guardar cuenta</button>
              <button type="button" id="btnCreditClear">&#x2715; Limpiar</button>
              <span class="text-muted" id="creditFormHint" style="font-size:12px">--</span>
            </div>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x1F4B0; Registrar pago a credito</div><span class="text-muted" id="ccPayCardName" style="font-size:12px">--</span></div>
        <div class="card-bd">
          <div class="form-field" style="margin-bottom:12px">
            <div class="form-label">Seleccionar cuenta</div>
            <div class="form-row"><select id="ccPaySelect"></select><button type="button" class="btn-ok" id="btnCcPayLoad">Cargar</button></div>
          </div>
          <div id="ccPayInfo" style="display:none;margin-bottom:12px;padding:12px;background:rgba(0,0,0,.2);border-radius:10px;border:1px solid var(--line)">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
              <div><div class="text-muted" style="font-size:10px">Saldo pendiente</div><div class="mono text-danger fw-900" id="ccInfoBalance" style="font-size:14px">--</div></div>
              <div><div class="text-muted" style="font-size:10px">Pago minimo</div><div class="mono text-warn" id="ccInfoMinPay" style="font-size:14px">--</div></div>
              <div><div class="text-muted" style="font-size:10px">Plan mensual</div><div class="mono text-ok" id="ccInfoPlan" style="font-size:14px">--</div></div>
            </div>
            <div class="prog-wrap" style="margin-top:10px">
              <div class="prog-bar-bg"><div class="prog-bar ok" id="ccInfoProgBar" style="width:0%"></div></div>
              <div class="prog-label"><span id="ccInfoProgLabel">Pagado: $0</span><span id="ccInfoProgPct">0%</span></div>
            </div>
          </div>
          <div class="form-grid" style="margin-bottom:12px">
            <div class="form-field"><div class="form-label">Fecha de pago</div><input id="ccPayDate" type="date"></div>
            <div class="form-field"><div class="form-label">Monto pagado</div><input id="ccPayAmount" type="number" step="0.01" min="0"></div>
          </div>
          <div class="form-row" style="margin-bottom:12px"><input id="ccPayNote" type="text" placeholder="Nota (opcional)" maxlength="120"></div>
          <button class="btn-ok" id="btnCcConfirmPay" disabled style="width:100%">&#x2705; Registrar pago</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd"><div class="card-hd-title">&#x1F4B3; Mis cuentas de credito</div><button class="btn-primary" id="btnCreditRefresh">&#x21BB; Actualizar</button></div>
      <div class="card-bd"><div id="creditList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px"><div class="text-muted">Sin cuentas registradas.</div></div></div>
    </div>
  </div>

  <!-- ===== REPORTES ===== -->
  <div class="tab-pane" id="tabReports">
    <div class="gap-8" style="margin-bottom:16px">
      <span class="text-muted" style="font-size:12px">Periodo:</span>
      <select id="reportPeriod" style="font-size:12px;padding:7px 11px">
        <option value="thismonth">Este mes</option>
        <option value="lastmonth">Mes anterior</option>
        <option value="last3">Ultimos 3 meses</option>
        <option value="last6">Ultimos 6 meses</option>
        <option value="year">Este ano</option>
        <option value="all">Todo el historial</option>
      </select>
      <button class="btn-primary" id="btnGenerateReport">&#x1F4CA; Generar reporte</button>
      <button class="btn-ok" id="btnExportCSV">&#x2B07; Exportar CSV</button>
    </div>
    <div class="kpi-grid" style="margin-bottom:20px">
      <div class="kpi accent"><div class="kpi-label">Total pagado (bills)</div><div class="kpi-value" id="rTotalBills">$0</div><div class="kpi-sub" id="rBillsCount">0 pagos</div></div>
      <div class="kpi ok"><div class="kpi-label">Total pagado (creditos)</div><div class="kpi-value" id="rTotalCredit">$0</div><div class="kpi-sub" id="rCreditCount">0 pagos</div></div>
      <div class="kpi warn"><div class="kpi-label">Grand total</div><div class="kpi-value" id="rGrandTotal">$0</div><div class="kpi-sub">Bills + Creditos</div></div>
      <div class="kpi"><div class="kpi-label">Deuda restante</div><div class="kpi-value" id="rCreditDebt" style="color:var(--danger)">$0</div><div class="kpi-sub">Saldos actuales</div></div>
    </div>
    <div class="card-grid">
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x1F4CB; Pagos de Bills</div><span class="text-muted mono" id="rBillsPeriodLabel" style="font-size:11px">--</span></div>
        <div class="card-bd" style="padding:0"><div class="table-wrap"><table>
          <thead><tr><th>Fecha</th><th>Bill</th><th>Monto</th><th>Nota</th></tr></thead>
          <tbody id="rBillsBody"></tbody>
        </table></div></div>
      </div>
      <div class="card">
        <div class="card-hd"><div class="card-hd-title">&#x1F4B3; Pagos de Creditos</div><span class="text-muted mono" id="rCreditPeriodLabel" style="font-size:11px">--</span></div>
        <div class="card-bd" style="padding:0"><div class="table-wrap"><table>
          <thead><tr><th>Fecha</th><th>Cuenta</th><th>Pagado</th><th>Saldo tras pago</th></tr></thead>
          <tbody id="rCreditBody"></tbody>
        </table></div></div>
      </div>
    </div>
  </div>

</div><!-- /wrap -->

<!-- MODAL SUPABASE -->
<div class="modal-back" id="supaModal">
  <div class="modal">
    <div class="card-hd"><div><div class="card-hd-title">&#x2699;&#xFE0F; Configuracion Supabase</div><div class="card-hd-sub">Conecta tu base de datos en la nube</div></div><button class="btn-danger" onclick="closeSupaModal()">&#x2715;</button></div>
    <div class="card-bd">
      <div class="conn-status-box chk-c" id="supaConnBox"><div class="csb-dot"></div><span id="supaConnText">Sin verificar</span></div>
      <div class="divider"></div>
      <div class="sb-field">
        <label>&#x1F517; Project URL</label>
        <input type="text" id="sbUrl" placeholder="https://xxxxxxxxxxxx.supabase.co" autocomplete="off">
        <div class="key-preview" id="sbUrlPreview">--</div>
      </div>
      <div class="sb-field">
        <label>&#x1F511; Anon Key <span id="anonKeyTag" style="font-size:11px;margin-left:6px"></span></label>
        <input type="password" id="sbKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
        <div class="key-preview" id="sbKeyPreview">--</div>
        <div class="text-muted" style="font-size:11px;margin-top:4px">Debe empezar con <code style="font-family:var(--mono);color:var(--accent)">eyJ</code> y tener ~200 caracteres.</div>
      </div>
      <div class="gap-8" style="margin-bottom:14px">
        <button class="btn-primary" id="btnSbSave">&#x1F4BE; Guardar</button>
        <button class="btn-ok" id="btnSbTest">&#x1F50C; Probar conexion</button>
        <button class="btn-danger" id="btnSbClear">&#x1F5D1; Borrar</button>
      </div>
      <div id="sbTestResult" style="display:none;padding:12px;border-radius:10px;font-family:var(--mono);font-size:13px"></div>
      <div class="step-guide">
        <h4>&#x1F4CB; Como obtener la Anon Key</h4>
        <ol>
          <li>Ve a <code>supabase.com</code> y selecciona tu proyecto</li>
          <li>Menu izquierdo &rarr; <code>Settings</code> &rarr; <code>API</code></li>
          <li>Copia la clave <code>anon &middot; public</code> (empieza con <code>eyJ</code>)</li>
          <li>Pega arriba y presiona <code>Guardar</code> luego <code>Probar conexion</code></li>
        </ol>
      </div>
      <div class="step-guide" style="margin-top:12px">
        <h4>&#x1F5C4; SQL para crear las 4 tablas necesarias</h4>
        <ol>
          <li>Ve a <code>SQL Editor</code> en tu dashboard de Supabase</li>
          <li>Crea: <code>bills</code>, <code>payments</code>, <code>credit_accounts</code>, <code>credit_payments</code></li>
          <li>Deshabilita RLS: <code>ALTER TABLE nombre DISABLE ROW LEVEL SECURITY;</code></li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL BILL -->
<div class="modal-back" id="histModal">
  <div class="modal modal-lg">
    <div class="card-hd"><div><div class="card-hd-title">&#x1F4CB; Historial de pagos</div><div class="card-hd-sub" id="histTitle">--</div></div><div class="gap-8"><button class="btn-ok" id="btnHistCSV">&#x2B07; CSV</button><button class="btn-danger" id="btnHistClose">&#x2715; Cerrar</button></div></div>
    <div class="card-bd">
      <div class="gap-8" style="margin-bottom:12px"><span class="text-muted">Total: <b class="mono" id="histTotal">--</b></span><span class="text-muted">Pagos: <b class="mono" id="histCount">0</b></span></div>
      <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Monto</th><th>Nota</th><th>Accion</th></tr></thead><tbody id="histBody"></tbody></table></div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL CREDITO -->
<div class="modal-back" id="creditHistModal">
  <div class="modal modal-lg">
    <div class="card-hd"><div><div class="card-hd-title">&#x1F4B3; Historial &mdash; Credito</div><div class="card-hd-sub" id="creditHistTitle">--</div></div><div class="gap-8"><button class="btn-danger" id="btnCreditHistClose">&#x2715; Cerrar</button></div></div>
    <div class="card-bd">
      <div class="gap-8" style="margin-bottom:12px"><span class="text-muted">Total abonado: <b class="mono" id="creditHistTotal">--</b></span><span class="text-muted">Pagos: <b class="mono" id="creditHistCount">0</b></span></div>
      <div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Monto</th><th>Saldo tras pago</th><th>Nota</th><th>Accion</th></tr></thead><tbody id="creditHistBody"></tbody></table></div>
    </div>
  </div>
</div>

<!-- MODAL NOMBRE BILL -->
<div class="modal-back" id="billNameModal">
  <div class="modal">
    <div class="card-hd"><div class="card-hd-title">&#x2795; Agregar nombre de bill</div><button class="btn-danger" id="btnBillNameClose">&#x2715;</button></div>
    <div class="card-bd">
      <div class="form-label">Nombre</div>
      <input id="billNameNew" type="text" placeholder="Luz / Renta / Seguro..." style="width:100%;margin-top:8px" maxlength="60">
      <div class="gap-8" style="margin-top:14px"><button class="btn-ok" id="btnBillNameSave">Guardar</button><span class="text-muted" id="billNameHint" style="font-size:12px">--</span></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- SINGLE TAB LOCK -->
<script>
(function(){
  const LOCK_KEY = 'fc_tab_lock';
  const TAB_ID   = Date.now() + '_' + Math.random().toString(36).slice(2);
  localStorage.setItem(LOCK_KEY, TAB_ID);
  window.addEventListener('storage', function(e){
    if(e.key === LOCK_KEY && e.newValue !== TAB_ID) showBlocked();
  });
  window.addEventListener('load', function(){
    if(localStorage.getItem(LOCK_KEY) !== TAB_ID) showBlocked();
  });
  window.addEventListener('beforeunload', function(){
    if(localStorage.getItem(LOCK_KEY) === TAB_ID) localStorage.removeItem(LOCK_KEY);
  });
  function showBlocked(){
    document.body.innerHTML = `<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#080f1e;font-family:'Cabinet Grotesk',system-ui,sans-serif;color:#dce8ff;text-align:center;padding:40px;"><div style="width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,#3d9fff,#00d4a8);display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:28px;">游눯</div><h1 style="font-size:26px;font-weight:900;letter-spacing:-.5px;margin-bottom:12px;">Finance Control ya est치 abierto</h1><p style="color:#7a8fae;font-size:15px;max-width:380px;line-height:1.6;margin-bottom:32px;">La aplicaci칩n solo puede ejecutarse en una pesta침a a la vez.<br>Cierra esta ventana y regresa a la pesta침a original.</p><button onclick="window.close()" style="cursor:pointer;font-family:inherit;font-size:14px;font-weight:700;padding:12px 28px;border-radius:12px;border:1px solid rgba(61,159,255,.4);background:rgba(61,159,255,.2);color:#7cc4ff;">Cerrar esta pesta침a</button></div>`;
    throw new Error('fc:duplicate-tab');
  }
})();
</script>

<script type="module">
/* == SUPABASE == */
let sb = null;
async function loadSB(url, key) {
  try { const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2"); return createClient(url, key); } catch { return null; }
}
const CRED_KEY = "fc_sb_v3";
function loadCreds() { try { return JSON.parse(localStorage.getItem(CRED_KEY)) || {}; } catch { return {}; } }
function saveCreds(url, key) { localStorage.setItem(CRED_KEY, JSON.stringify({ url, key })); }
function clearCreds() { localStorage.removeItem(CRED_KEY); }
function isJWT(s) { return typeof s === "string" && s.startsWith("eyJ") && s.length > 100; }
function isURL(s) { try { new URL(s); return s.includes("supabase.co"); } catch { return false; } }
function getSB() { if (!sb) throw new Error("Supabase no configurado. Haz clic en Supabase para configurar."); return sb; }
async function initSB() { const c = loadCreds(); if (c.url && c.key) { sb = await loadSB(c.url, c.key); window.sb = sb; } updateConnBadge(); }
async function updateConnBadge() {
  const badge = g("connBadge"), txt = g("connBadgeText"), c = loadCreds();
  if (!c.url || !c.key) { badge.className="conn-badge err"; txt.textContent="No configurado"; return; }
  badge.className="conn-badge checking"; txt.textContent="Verificando...";
  try { const{error}=await getSB().from("bills").select("id").limit(1); if(error)throw error; badge.className="conn-badge ok"; txt.textContent="Conectado "+new Date().toLocaleTimeString("es",{hour:"2-digit",minute:"2-digit"}); }
  catch { badge.className="conn-badge err"; txt.textContent="Sin conexion"; }
}

/* == INDEXEDDB LOCAL == */
const DB_NAME="fc_v3",DB_VER=1;
function openDB(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,DB_VER);req.onupgradeneeded=()=>{const db=req.result;["settings","bills","payments","credit_accounts","credit_payments"].forEach(n=>{if(!db.objectStoreNames.contains(n)){const st=db.createObjectStore(n,n==="settings"?undefined:{keyPath:"id"});if(n==="payments")st.createIndex("by_bill","bill_id",{unique:false});if(n==="credit_payments")st.createIndex("by_account","account_id",{unique:false});}});};req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);});}
const uid=()=>crypto.randomUUID?crypto.randomUUID():"id_"+Math.random().toString(16).slice(2)+Date.now();
async function idbGet(store,key,fb){try{const db=await openDB();return await new Promise((res,rej)=>{const r=db.transaction(store,"readonly").objectStore(store).get(key);r.onsuccess=()=>res(r.result??fb);r.onerror=()=>rej(r.error);});}catch{return fb;}}
async function idbPut(store,value,key){const db=await openDB();return new Promise((res,rej)=>{const r=key!==undefined?db.transaction(store,"readwrite").objectStore(store).put(value,key):db.transaction(store,"readwrite").objectStore(store).put(value);r.onsuccess=()=>res(true);r.onerror=()=>rej(r.error);});}
async function wipeDB(){return new Promise(res=>{const r=indexedDB.deleteDatabase(DB_NAME);r.onsuccess=()=>res(true);r.onerror=()=>res(false);r.onblocked=()=>res(false);});}
const getSetting=(k,fb)=>idbGet("settings",k,fb);
const setSetting=(k,v)=>idbPut("settings",v,k);

/* == CRUD SUPABASE == */
const upsert=(table,row)=>getSB().from(table).upsert(row,{onConflict:"id"}).then(({error})=>{if(error)throw error;});
const selectAll=(table)=>getSB().from(table).select("*").then(({data,error})=>{if(error)throw error;return data||[];});
const selectEq=(table,col,val)=>getSB().from(table).select("*").eq(col,val).then(({data,error})=>{if(error)throw error;return(data||[]).sort((a,b)=>a.pay_date>b.pay_date?-1:1);});
const del=(table,id)=>getSB().from(table).delete().eq("id",id).then(({error})=>{if(error)throw error;});
const delEq=(table,col,val)=>getSB().from(table).delete().eq(col,val).then(({error})=>{if(error)throw error;});

async function putBill(b){await upsert("bills",b);}
async function listBills(){return(await selectAll("bills")).sort((a,b)=>a.next_due_date>b.next_due_date?1:-1);}
async function deleteBill(id){await delEq("payments","bill_id",id);await del("bills",id);}
async function addPayment(p){await upsert("payments",p);}
async function listPaysByBill(billId){return selectEq("payments","bill_id",billId);}
async function deletePayment(id){await del("payments",id);}
async function allPayments(){return selectAll("payments");}
async function putCreditAccount(a){await upsert("credit_accounts",a);}
async function listCreditAccounts(){return selectAll("credit_accounts");}
async function deleteCreditAccount(id){await delEq("credit_payments","account_id",id);await del("credit_accounts",id);}
async function addCreditPayment(p){await upsert("credit_payments",p);}
async function listCreditPaysByAccount(id){return selectEq("credit_payments","account_id",id);}
async function deleteCreditPayment(id){await del("credit_payments",id);}
async function allCreditPayments(){return selectAll("credit_payments");}

/* == HELPERS == */
const g=id=>document.getElementById(id);
const toast=m=>{const t=g("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2800);};
function todayISO(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function toISO(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function parseISO(s){const[y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);}
function daysBetween(a,b){return Math.floor((parseISO(b)-parseISO(a))/864e5);}
function dueForMonth(y,m,day){const max=new Date(y,m+1,0).getDate();return new Date(y,m,Math.min(Math.max(1,Number(day||1)),max));}
function initNextDue(day){const n=new Date(),today=new Date(n.getFullYear(),n.getMonth(),n.getDate()),tm=dueForMonth(n.getFullYear(),n.getMonth(),day);return toISO(tm>=today?tm:dueForMonth(n.getFullYear(),n.getMonth()+1,day));}
function nextDueAfterPay(curISO,day){const b=curISO?parseISO(curISO):new Date();return toISO(dueForMonth(b.getFullYear(),b.getMonth()+1,day));}
function fmtMoney(v,cur="USD"){try{return new Intl.NumberFormat("en-US",{style:"currency",currency:cur}).format(Number(v||0));}catch{return"$"+Number(v||0).toFixed(2);}}
function esc(s){return(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");}
function pct(a,b){return b>0?Math.round((a/b)*100):0;}

/* == STATE == */
let ST={bills:[],creditAccounts:[],currency:"USD",remindDays:7,editBillId:null,payBillId:null,histBillId:null,editCreditId:null,payCreditId:null,creditHistId:null};

/* == BUILD SELECTS == */
function buildDays(selId){const s=g(selId);if(!s)return;s.innerHTML="";for(let i=1;i<=31;i++){const o=document.createElement("option");o.value=String(i);o.textContent="Dia "+i;s.appendChild(o);}}
async function getNameLib(){return await getSetting("billNameLib",[]);}
async function setNameLib(names){const u=Array.from(new Set((names||[]).map(x=>String(x||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));await setSetting("billNameLib",u);return u;}
async function rebuildBillCombo(sel=""){const lib=await getNameLib(),dbN=(ST.bills||[]).map(b=>b.name).filter(Boolean),all=await setNameLib([...lib,...dbN]),el=g("billNameSelect");el.innerHTML="";el.appendChild(Object.assign(document.createElement("option"),{value:"",textContent:"Selecciona..."}));all.forEach(n=>el.appendChild(Object.assign(document.createElement("option"),{value:n,textContent:n})));el.value=sel||"";}
function rebuildPaySelect(sel=""){const el=g("payBillSelect");el.innerHTML="";el.appendChild(Object.assign(document.createElement("option"),{value:"",textContent:"Selecciona..."}));ST.bills.forEach(b=>el.appendChild(Object.assign(document.createElement("option"),{value:b.id,textContent:`${b.name}${b.next_due_date?" - "+b.next_due_date:""}`})));el.value=sel||"";}
function rebuildCcSelect(sel=""){const el=g("ccPaySelect");el.innerHTML="";el.appendChild(Object.assign(document.createElement("option"),{value:"",textContent:"Selecciona..."}));ST.creditAccounts.forEach(a=>el.appendChild(Object.assign(document.createElement("option"),{value:a.id,textContent:`${a.name}${a.last4?" ..."+a.last4:""} - Saldo: ${fmtMoney(a.balance,a.currency||ST.currency)}`})));el.value=sel||"";}

/* == REFRESH == */
async function refresh(){
  ST.currency=await getSetting("currency","USD");ST.remindDays=Number(await getSetting("remindDays",7));
  g("currency").value=ST.currency;g("currencyLabel").textContent=ST.currency;g("remindDays").value=String(ST.remindDays);
  try{ST.bills=await listBills();ST.creditAccounts=await listCreditAccounts();}catch(e){toast("Error: "+(e?.message||e));ST.bills=[];ST.creditAccounts=[];}
  await rebuildBillCombo(g("billNameSelect")?.value||"");rebuildPaySelect(g("payBillSelect")?.value||"");rebuildCcSelect(g("ccPaySelect")?.value||"");
  renderDash();renderBillsTable();renderCreditList();
}

/* == BILL STATUS == */
function billSt(b,rd,today){const d=daysBetween(today,b.next_due_date);if(d<0)return{key:"overdue",label:"Vencido "+Math.abs(d)+"d",d};if(d<=rd)return{key:"soon",label:d+"d",d};return{key:"ok",label:d+"d",d};}

/* == DASHBOARD == */
function renderDash(){
  const today=todayISO(),rd=ST.remindDays;
  let cO=0,cS=0,cK=0,tot=0;
  ST.bills.forEach(b=>{tot+=Number(b.amount_monthly||0);const s=billSt(b,rd,today);if(s.key==="overdue")cO++;else if(s.key==="soon")cS++;else cK++;});
  g("kTotalMonthly").textContent=fmtMoney(tot,ST.currency);g("kOverdue").textContent=String(cO);g("kSoon").textContent=String(cS);g("kOk").textContent=String(cK);
  g("kOverdueSub").textContent=cO?"Tienes bills vencidos":"--";g("kSoonSub").textContent=cS?"Vencen en <="+rd+" dias":"--";
  const urgent=[...ST.bills].filter(b=>billSt(b,rd,today).key!=="ok").sort((a,b)=>a.next_due_date>b.next_due_date?1:-1).slice(0,8);
  const tb=g("dashBillsBody");tb.innerHTML="";
  (urgent.length?urgent:ST.bills.slice(0,6)).forEach(b=>{const s=billSt(b,rd,today),pillCls=s.key==="overdue"?"pill overdue":s.key==="soon"?"pill soon":"pill ok-p",tr=document.createElement("tr");tr.innerHTML=`<td><span class="${pillCls}">${s.label}</span></td><td><b>${esc(b.name)}</b></td><td class="mono">${esc(b.next_due_date||"--")}</td><td class="mono">${fmtMoney(b.amount_monthly,ST.currency)}</td><td><button class="btn-ok" style="padding:5px 10px;font-size:12px" data-pay="${b.id}">Pagar</button></td>`;tb.appendChild(tr);});
  tb.querySelectorAll("[data-pay]").forEach(btn=>btn.onclick=()=>beginPay(btn.dataset.pay));
  if(!urgent.length&&!ST.bills.length)tb.innerHTML=`<tr><td colspan="5" class="text-muted" style="padding:16px">Sin bills registrados. Agregalos en la pestana Bills.</td></tr>`;
  let td=0,tl=0,ti=0,cnt=ST.creditAccounts.length;
  ST.creditAccounts.forEach(a=>{td+=Number(a.balance||0);tl+=Number(a.credit_limit||0);if(a.apr)ti+=Number(a.apr);});
  const up=tl>0?Math.round((td/tl)*100):0,avgApr=cnt>0?(ti/cnt).toFixed(1):"0";
  g("kCreditTotal").textContent=fmtMoney(td,ST.currency);g("kCreditLimit").textContent=fmtMoney(tl,ST.currency);g("kCreditUtil").textContent=up+"%";
  g("kCreditUtil").closest(".kpi").className="kpi"+(up>70?" danger":up>30?" warn":" ok");
  g("kCreditAPR").textContent=avgApr+"%";g("kCreditCount").textContent=String(cnt);
  const now=new Date(),m1=toISO(new Date(now.getFullYear(),now.getMonth(),1)),m2=toISO(new Date(now.getFullYear(),now.getMonth()+1,0));
  const dashList=g("dashCreditList");dashList.innerHTML="";
  if(!ST.creditAccounts.length){dashList.innerHTML=`<div class="text-muted" style="font-size:13px">Sin cuentas de credito.</div>`;return;}
  ST.creditAccounts.forEach(a=>{const cur=a.currency||ST.currency,bal=Number(a.balance||0),lim=Number(a.credit_limit||0),used=lim>0?pct(bal,lim):0,barCls=used>70?"danger":used>30?"warn":"ok",div=document.createElement("div");div.className="cc-item";div.innerHTML=`<div class="cc-header"><div><div class="cc-name">${esc(a.name)}</div><div class="cc-bank">${esc(a.bank||"")}${a.last4?" ..."+a.last4:""}</div></div><span class="pill ${used>70?"overdue":used>30?"warn-p":"ok-p"}">${used}% uso</span></div><div class="cc-amounts"><div class="cc-amount-item"><div class="cc-amount-label">Saldo</div><div class="cc-amount-value text-danger">${fmtMoney(bal,cur)}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Limite</div><div class="cc-amount-value">${fmtMoney(lim,cur)}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Disponible</div><div class="cc-amount-value text-ok">${fmtMoney(Math.max(0,lim-bal),cur)}</div></div></div>${lim>0?`<div class="prog-wrap"><div class="prog-bar-bg"><div class="prog-bar ${barCls}" style="width:${Math.min(used,100)}%"></div></div><div class="prog-label"><span>${fmtMoney(bal,cur)}</span><span>${used}%</span></div></div>`:""} ${a.plan_amount?`<div style="margin-top:8px;font-size:12px;color:var(--ok)">Plan: ${fmtMoney(a.plan_amount,cur)}/mes</div>`:""}`;dashList.appendChild(div);});
}

/* == BILLS TABLE == */
function renderBillsTable(){
  const today=todayISO(),rd=Number(g("remindDays").value||ST.remindDays),filter=g("filter").value,q=(g("search").value||"").trim().toLowerCase();
  const items=ST.bills.filter(b=>{const s=billSt(b,rd,today);if(filter!=="all"&&s.key!==filter)return false;if(q&&!`${b.name||""} ${b.category||""} ${b.vendor||""}`.toLowerCase().includes(q))return false;return true;});
  const tb=g("tbody");tb.innerHTML="";
  items.forEach(b=>{const s=billSt(b,rd,today),pc=s.key==="overdue"?"pill overdue":s.key==="soon"?"pill soon":"pill ok-p",tr=document.createElement("tr");const linkBtn=b.pay_url?`<a href="${esc(b.pay_url)}" target="_blank" rel="noopener noreferrer"><button class="btn-primary" style="font-size:12px;padding:5px 9px" title="${esc(b.pay_url)}">&#x1F517;</button></a>`:`<button style="font-size:12px;padding:5px 9px;opacity:.3;cursor:not-allowed" disabled title="Sin link">&#x1F517;</button>`;tr.innerHTML=`<td><span class="${pc}">${s.label}</span></td><td><b>${esc(b.name)}</b><br><span class="text-muted" style="font-size:11px">${esc(b.category||"")}</span></td><td class="mono">Dia ${esc(String(b.due_day||""))}</td><td class="mono">${fmtMoney(b.amount_monthly,ST.currency)}</td><td class="mono">${esc(b.last_paid_date||"--")}</td><td class="mono"><b>${esc(b.next_due_date||"--")}</b></td><td>${esc(b.method||"")}</td><td><div class="actions-row"><button class="btn-ok" style="font-size:12px;padding:5px 9px" data-pay="${b.id}">Pagar</button>${linkBtn}<button style="font-size:12px;padding:5px 9px" data-hist="${b.id}">Hist.</button><button style="font-size:12px;padding:5px 9px" data-edit="${b.id}">Editar</button><button class="btn-danger" style="font-size:12px;padding:5px 9px" data-del="${b.id}">X</button></div></td>`;tb.appendChild(tr);});
  if(!items.length)tb.innerHTML=`<tr><td colspan="8" class="text-muted" style="padding:20px">Sin bills.</td></tr>`;
  tb.querySelectorAll("[data-pay]").forEach(btn=>btn.onclick=()=>beginPay(btn.dataset.pay));
  tb.querySelectorAll("[data-hist]").forEach(btn=>btn.onclick=()=>openBillHist(btn.dataset.hist));
  tb.querySelectorAll("[data-edit]").forEach(btn=>btn.onclick=()=>beginEditBill(btn.dataset.edit));
  tb.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=async()=>{if(!confirm("Borrar este bill y su historial?"))return;try{await deleteBill(btn.dataset.del);toast("Borrado");await refresh();}catch(e){toast("Error: "+e?.message);}});
}

/* == BTN TEST URL == */
g("btnTestUrl").onclick=()=>{const url=g("payUrl").value.trim();if(!url)return toast("Ingresa un link primero");try{new URL(url);window.open(url,"_blank","noopener,noreferrer");}catch{toast("URL inv치lida  debe empezar con https://");}};

/* == CREDIT LIST == */
function renderCreditList(){
  const el=g("creditList");el.innerHTML="";
  if(!ST.creditAccounts.length){el.innerHTML=`<div class="text-muted">Sin cuentas registradas.</div>`;return;}
  ST.creditAccounts.forEach(a=>{
    const cur=a.currency||ST.currency,bal=Number(a.balance||0),lim=Number(a.credit_limit||0),used=lim>0?pct(bal,lim):0,barCls=used>70?"danger":used>30?"warn":"ok";
    const planPaid=Number(a.plan_total_paid||0),planOrig=Number(a.plan_original_balance||bal),planPct=planOrig>0?pct(planPaid,planOrig):0;
    const isService=(a.account_type||"card")==="service";
    const div=document.createElement("div");div.className="cc-item";
    if(isService){
      div.innerHTML=`<div class="cc-header"><div><div class="cc-name">${esc(a.name)}</div><div class="cc-bank"><span class="pill warn-p" style="font-size:10px">&#x1F527; Repuesto/Servicio</span> ${esc(a.merchant_name||"")} ${a.service_type?" &middot; "+esc(a.service_type):""}</div></div><span class="pill overdue" style="font-size:13px">${fmtMoney(bal,cur)}</span></div><div class="cc-amounts"><div class="cc-amount-item"><div class="cc-amount-label">Adeuda</div><div class="cc-amount-value text-danger">${fmtMoney(bal,cur)}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Fecha</div><div class="cc-amount-value" style="font-size:12px">${esc(a.debt_date||"--")}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Telefono</div><div class="cc-amount-value" style="font-size:12px">${esc(a.phone||"--")}</div></div></div>${planPaid>0?`<div class="prog-wrap"><div class="prog-bar-bg"><div class="prog-bar ok" style="width:${Math.min(planPct,100)}%"></div></div><div class="prog-label"><span>Abonado: ${fmtMoney(planPaid,cur)}</span><span>Restante: ${fmtMoney(Math.max(0,planOrig-planPaid),cur)}</span></div></div>`:""}${a.notes?`<div style="margin-top:8px;font-size:12px;color:var(--muted)">${esc(a.notes)}</div>`:""}<div class="actions-row" style="margin-top:12px"><button class="btn-ok" style="font-size:12px;padding:5px 10px" data-ccpay="${a.id}">&#x1F4B0; Abonar</button><button style="font-size:12px;padding:5px 10px" data-cchist="${a.id}">Historial</button><button style="font-size:12px;padding:5px 10px" data-ccedit="${a.id}">Editar</button><button class="btn-danger" style="font-size:12px;padding:5px 10px" data-ccdel="${a.id}">X</button></div>`;
    } else {
      div.innerHTML=`<div class="cc-header"><div><div class="cc-name">${esc(a.name)}</div><div class="cc-bank"><span class="pill ${(a.account_type||"card")==="loan"?"soon":"ok-p"}" style="font-size:10px">${(a.account_type||"card")==="loan"?"&#x1F3E6; Prestamo":"&#x1F4B3; Tarjeta"}</span> ${esc(a.bank||"")}${a.last4?" ..."+a.last4:""}${a.apr?" &middot; APR "+a.apr+"%":""}</div></div><span class="pill ${used>70?"overdue":used>30?"warn-p":"ok-p"}">${used}% uso</span></div><div class="cc-amounts"><div class="cc-amount-item"><div class="cc-amount-label">Saldo</div><div class="cc-amount-value text-danger">${fmtMoney(bal,cur)}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Limite</div><div class="cc-amount-value">${fmtMoney(lim,cur)}</div></div><div class="cc-amount-item"><div class="cc-amount-label">Pago min.</div><div class="cc-amount-value text-warn">${fmtMoney(a.min_payment||0,cur)}</div></div></div>${lim>0?`<div class="prog-wrap"><div class="prog-bar-bg"><div class="prog-bar ${barCls}" style="width:${Math.min(used,100)}%"></div></div><div class="prog-label"><span>Usado: ${fmtMoney(bal,cur)}</span><span>${fmtMoney(Math.max(0,lim-bal),cur)} disponible</span></div></div>`:""}${a.plan_amount?`<div class="plan-box"><div style="font-size:11px;color:var(--ok);font-weight:700;margin-bottom:6px">PLAN DE PAGO</div><div class="plan-grid"><div><div class="text-muted">Mensual</div><b class="mono">${fmtMoney(a.plan_amount,cur)}</b></div><div><div class="text-muted">Pagado</div><b class="mono text-ok">${fmtMoney(planPaid,cur)}</b></div><div><div class="text-muted">Restante</div><b class="mono text-danger">${fmtMoney(Math.max(0,planOrig-planPaid),cur)}</b></div></div><div class="prog-wrap" style="margin-top:8px"><div class="prog-bar-bg"><div class="prog-bar ok" style="width:${Math.min(planPct,100)}%"></div></div><div class="prog-label"><span>Avance: ${planPct}%</span><span>${a.plan_months||"?"} meses</span></div></div></div>`:""}${a.notes?`<div style="margin-top:8px;font-size:12px;color:var(--muted)">${esc(a.notes)}</div>`:""}<div class="actions-row" style="margin-top:12px"><button class="btn-ok" style="font-size:12px;padding:5px 10px" data-ccpay="${a.id}">Abonar</button><button style="font-size:12px;padding:5px 10px" data-cchist="${a.id}">Historial</button><button style="font-size:12px;padding:5px 10px" data-ccedit="${a.id}">Editar</button><button class="btn-danger" style="font-size:12px;padding:5px 10px" data-ccdel="${a.id}">X</button></div>`;
    }
    el.appendChild(div);
  });
  el.querySelectorAll("[data-ccpay]").forEach(btn=>btn.onclick=()=>beginCreditPay(btn.dataset.ccpay));
  el.querySelectorAll("[data-cchist]").forEach(btn=>btn.onclick=()=>openCreditHist(btn.dataset.cchist));
  el.querySelectorAll("[data-ccedit]").forEach(btn=>btn.onclick=()=>beginEditCredit(btn.dataset.ccedit));
  el.querySelectorAll("[data-ccdel]").forEach(btn=>btn.onclick=async()=>{if(!confirm("Borrar esta cuenta y su historial?"))return;try{await deleteCreditAccount(btn.dataset.ccdel);toast("Cuenta borrada");await refresh();}catch(e){toast("Error: "+e?.message);}});
}

/* == BILL FORM == */
function clearBillForm(){ST.editBillId=null;g("editId").textContent="Nuevo";["billNameSelect","amount","category","vendor","payUrl"].forEach(id=>g(id).value="");g("dueDay").value="1";g("method").value="Cash";g("formHint").textContent="--";}
function beginEditBill(id){const b=ST.bills.find(x=>x.id===id);if(!b)return;ST.editBillId=id;g("editId").textContent=id.slice(-8);g("billNameSelect").value=b.name||"";g("amount").value=b.amount_monthly??"";g("dueDay").value=String(b.due_day??1);g("category").value=b.category||"";g("vendor").value=b.vendor||"";g("method").value=b.method||"Cash";g("payUrl").value=b.pay_url||"";g("formHint").textContent="Editando.";switchTab("tabBills");toast("Modo edicion");}
g("billForm").onsubmit=async ev=>{ev.preventDefault();const name=(g("billNameSelect").value||"").trim(),amount=Number(g("amount").value),dueDay=Number(g("dueDay").value);if(!name)return toast("Selecciona un nombre");if(!amount||amount<=0)return toast("Monto invalido");const cur=g("currency").value;await setSetting("currency",cur);ST.currency=cur;await setNameLib([...await getNameLib(),name]);const bill=ST.editBillId?(ST.bills.find(x=>x.id===ST.editBillId)||{id:ST.editBillId}):{id:uid()};bill.name=name;bill.amount_monthly=+amount.toFixed(2);bill.due_day=dueDay;bill.category=g("category").value.trim()||null;bill.vendor=g("vendor").value.trim()||null;bill.method=g("method").value;bill.pay_url=g("payUrl").value.trim()||null;if(!bill.next_due_date)bill.next_due_date=initNextDue(dueDay);try{await putBill(bill);toast(ST.editBillId?"Bill actualizado":"Bill creado");clearBillForm();await refresh();}catch(e){toast("Error: "+e?.message);}};
g("btnClear").onclick=()=>{clearBillForm();toast("Limpio");};

/* == PAY BILL == */
function resetPayBox(){ST.payBillId=null;g("payBillName").textContent="--";g("payBillSelect").value="";g("payDate").value=todayISO();g("payAmount").value="";g("payNote").value="";g("btnConfirmPay").disabled=true;}
function setPayBill(b){ST.payBillId=b.id;g("payBillName").textContent=b.name;g("payDate").value=todayISO();g("payAmount").value=String(b.amount_monthly??"");g("payNote").value="";g("btnConfirmPay").disabled=false;}
function beginPay(billId){const b=ST.bills.find(x=>x.id===billId);if(!b)return;g("payBillSelect").value=billId;setPayBill(b);switchTab("tabBills");toast("Listo para marcar pagado");}
g("btnPayLoad").onclick=()=>{const b=ST.bills.find(x=>x.id===g("payBillSelect").value);if(!b)return toast("Selecciona un bill");setPayBill(b);};
g("payBillSelect").onchange=()=>{const b=ST.bills.find(x=>x.id===g("payBillSelect").value);b?setPayBill(b):resetPayBox();};
g("btnConfirmPay").onclick=async()=>{if(!ST.payBillId)return;const b=ST.bills.find(x=>x.id===ST.payBillId);if(!b)return;const amt=Number(g("payAmount").value);if(!amt||amt<=0)return toast("Monto invalido");const payDate=g("payDate").value||todayISO();const pay={id:uid(),bill_id:b.id,bill_name:b.name,pay_date:payDate,amount_paid:+amt.toFixed(2),note:g("payNote").value.trim()||null,created_at:new Date().toISOString()};try{await addPayment(pay);b.last_paid_date=payDate;b.last_paid_amount=+amt.toFixed(2);b.next_due_date=nextDueAfterPay(b.next_due_date,b.due_day);b.last_notified_date=null;await putBill(b);toast("Pagado. Proximo: "+b.next_due_date);resetPayBox();await refresh();}catch(e){toast("Error: "+e?.message);}};

/* == CREDIT FORM == */
function setAccType(type){
  g("ccAccountType").value=type;
  ["typeBtnCard","typeBtnLoan","typeBtnService"].forEach(id=>g(id)&&g(id).classList.remove("active"));
  if(type==="card")g("typeBtnCard").classList.add("active");
  else if(type==="loan")g("typeBtnLoan").classList.add("active");
  else g("typeBtnService").classList.add("active");
  g("ccFieldsCardLoan").style.display=type==="service"?"none":"block";
  g("ccFieldsService").style.display=type==="service"?"block":"none";
}
window.setAccType=setAccType;
function clearCreditForm(){ST.editCreditId=null;g("creditEditId").textContent="Nueva";["ccName","ccBank","ccLast4","ccLimit","ccBalance","ccApr","ccMinPayment","ccPlanAmount","ccPlanMonths","ccNotes","ccMerchant","ccServiceType","ccBalanceService","ccPhone"].forEach(id=>{if(g(id))g(id).value="";});if(g("ccDebtDate"))g("ccDebtDate").value="";g("ccCutDay").value="1";g("ccPayDay").value="1";g("ccCurrency").value="USD";g("creditFormHint").textContent="--";setAccType("card");}
function beginEditCredit(id){const a=ST.creditAccounts.find(x=>x.id===id);if(!a)return;ST.editCreditId=id;g("creditEditId").textContent=id.slice(-8);setAccType(a.account_type||"card");g("ccName").value=a.name||"";g("ccBank").value=a.bank||"";g("ccLast4").value=a.last4||"";g("ccLimit").value=a.credit_limit||"";g("ccBalance").value=a.balance||"";g("ccApr").value=a.apr||"";g("ccMinPayment").value=a.min_payment||"";g("ccCutDay").value=String(a.cut_day||1);g("ccPayDay").value=String(a.pay_day||1);g("ccCurrency").value=a.currency||"USD";g("ccPlanAmount").value=a.plan_amount||"";g("ccPlanMonths").value=a.plan_months||"";g("ccNotes").value=a.notes||"";if(g("ccMerchant"))g("ccMerchant").value=a.merchant_name||"";if(g("ccServiceType"))g("ccServiceType").value=a.service_type||"";if(g("ccBalanceService"))g("ccBalanceService").value=a.balance||"";if(g("ccDebtDate"))g("ccDebtDate").value=a.debt_date||"";if(g("ccPhone"))g("ccPhone").value=a.phone||"";g("creditFormHint").textContent="Editando.";switchTab("tabCredit");toast("Modo edicion credito");}
g("creditForm").onsubmit=async ev=>{ev.preventDefault();const name=(g("ccName").value||"").trim(),accType=g("ccAccountType").value||"card";if(!name)return toast("Ingresa el nombre");
const isService=accType==="service";
const balance=isService?Number(g("ccBalanceService").value):Number(g("ccBalance").value);
if(isNaN(balance)||balance<0)return toast("Saldo invalido");
const acc=ST.editCreditId?(ST.creditAccounts.find(x=>x.id===ST.editCreditId)||{id:ST.editCreditId}):{id:uid()};
acc.name=name;acc.account_type=accType;acc.currency=g("ccCurrency").value;acc.notes=g("ccNotes").value.trim()||null;acc.balance=+balance.toFixed(2);
if(isService){acc.merchant_name=g("ccMerchant").value.trim()||null;acc.service_type=g("ccServiceType").value.trim()||null;acc.debt_date=g("ccDebtDate").value||null;acc.phone=g("ccPhone").value.trim()||null;acc.credit_limit=0;acc.apr=null;acc.min_payment=null;acc.plan_amount=null;acc.plan_months=null;}
else{acc.bank=g("ccBank").value.trim()||null;acc.last4=g("ccLast4").value.trim()||null;acc.credit_limit=+Number(g("ccLimit").value||0).toFixed(2);acc.apr=+Number(g("ccApr").value||0).toFixed(2)||null;acc.min_payment=+Number(g("ccMinPayment").value||0).toFixed(2)||null;acc.cut_day=Number(g("ccCutDay").value||1);acc.pay_day=Number(g("ccPayDay").value||1);acc.plan_amount=+Number(g("ccPlanAmount").value||0).toFixed(2)||null;acc.plan_months=Number(g("ccPlanMonths").value||0)||null;}
if(!ST.editCreditId)acc.plan_original_balance=acc.balance;if(!acc.plan_total_paid)acc.plan_total_paid=0;
try{await putCreditAccount(acc);toast(ST.editCreditId?"Cuenta actualizada":"Cuenta creada");clearCreditForm();await refresh();}catch(e){toast("Error: "+e?.message);}};
g("btnCreditClear").onclick=()=>{clearCreditForm();toast("Limpio");};

/* == CREDIT PAY == */
function resetCcPay(){ST.payCreditId=null;g("ccPayCardName").textContent="--";g("ccPaySelect").value="";g("ccPayDate").value=todayISO();g("ccPayAmount").value="";g("ccPayNote").value="";g("btnCcConfirmPay").disabled=true;g("ccPayInfo").style.display="none";}
function loadCcInfo(a){ST.payCreditId=a.id;g("ccPayCardName").textContent=a.name;g("ccPayDate").value=todayISO();g("ccPayAmount").value=a.plan_amount||a.min_payment||"";g("ccPayNote").value="";g("btnCcConfirmPay").disabled=false;const cur=a.currency||ST.currency;g("ccInfoBalance").textContent=fmtMoney(a.balance,cur);g("ccInfoMinPay").textContent=a.min_payment?fmtMoney(a.min_payment,cur):"--";g("ccInfoPlan").textContent=a.plan_amount?fmtMoney(a.plan_amount,cur):"--";const orig=Number(a.plan_original_balance||a.balance),paid=Number(a.plan_total_paid||0),p=pct(paid,orig);g("ccInfoProgBar").style.width=Math.min(p,100)+"%";g("ccInfoProgLabel").textContent="Pagado: "+fmtMoney(paid,cur);g("ccInfoProgPct").textContent=p+"%";g("ccPayInfo").style.display="block";}
function beginCreditPay(id){const a=ST.creditAccounts.find(x=>x.id===id);if(!a)return;g("ccPaySelect").value=id;loadCcInfo(a);switchTab("tabCredit");toast("Listo para registrar pago");}
g("btnCcPayLoad").onclick=()=>{const a=ST.creditAccounts.find(x=>x.id===g("ccPaySelect").value);if(!a)return toast("Selecciona una cuenta");loadCcInfo(a);};
g("ccPaySelect").onchange=()=>{const a=ST.creditAccounts.find(x=>x.id===g("ccPaySelect").value);a?loadCcInfo(a):resetCcPay();};
g("btnCcConfirmPay").onclick=async()=>{if(!ST.payCreditId)return;const a=ST.creditAccounts.find(x=>x.id===ST.payCreditId);if(!a)return;const amt=Number(g("ccPayAmount").value);if(!amt||amt<=0)return toast("Monto invalido");const payDate=g("ccPayDate").value||todayISO(),newBal=Math.max(0,Number(a.balance)-amt);const pay={id:uid(),account_id:a.id,account_name:a.name,pay_date:payDate,amount_paid:+amt.toFixed(2),balance_after:+newBal.toFixed(2),note:g("ccPayNote").value.trim()||null,created_at:new Date().toISOString()};try{await addCreditPayment(pay);a.balance=+newBal.toFixed(2);a.plan_total_paid=+(Number(a.plan_total_paid||0)+amt).toFixed(2);await putCreditAccount(a);toast("Abono registrado. Saldo restante: "+fmtMoney(newBal,a.currency||ST.currency));resetCcPay();await refresh();}catch(e){toast("Error: "+e?.message);}};

/* == BILL HISTORY == */
async function openBillHist(billId){const b=ST.bills.find(x=>x.id===billId);if(!b)return;ST.histBillId=billId;g("histTitle").textContent=b.name+" | "+fmtMoney(b.amount_monthly,ST.currency)+" | Proximo: "+b.next_due_date;await renderBillHist();g("histModal").classList.add("show");}
async function renderBillHist(){if(!ST.histBillId)return;try{const pays=await listPaysByBill(ST.histBillId),total=pays.reduce((s,p)=>s+Number(p.amount_paid||0),0);g("histTotal").textContent=fmtMoney(total,ST.currency);g("histCount").textContent=String(pays.length);const tb=g("histBody");tb.innerHTML="";pays.forEach(p=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="mono">${esc(p.pay_date)}</td><td class="mono">${fmtMoney(p.amount_paid,ST.currency)}</td><td>${esc(p.note||"")}</td><td><button class="btn-danger" style="font-size:12px;padding:4px 9px" data-dp="${p.id}">X</button></td>`;tb.appendChild(tr);});tb.querySelectorAll("[data-dp]").forEach(btn=>btn.onclick=async()=>{if(!confirm("Borrar este pago?"))return;try{await deletePayment(btn.dataset.dp);toast("Borrado");await renderBillHist();}catch(e){toast("Error: "+e?.message);}});}catch(e){toast("Error: "+e?.message);}}
g("btnHistClose").onclick=()=>{ST.histBillId=null;g("histModal").classList.remove("show");};
g("histModal").onclick=e=>{if(e.target===g("histModal")){ST.histBillId=null;g("histModal").classList.remove("show");}};
g("btnHistCSV").onclick=async()=>{const b=ST.bills.find(x=>x.id===ST.histBillId);if(!b)return;try{const pays=await listPaysByBill(ST.histBillId),rows=[["bill","pay_date","amount_paid","note"].join(",")];pays.reverse().forEach(p=>rows.push([`"${b.name.replaceAll('"','""')}"`,p.pay_date,p.amount_paid,`"${(p.note||"").replaceAll('"','""')}"`].join(",")));dlFile(`historial_${b.name.replaceAll(" ","_")}.csv`,rows.join("\n"),"text/csv");toast("CSV exportado");}catch(e){toast("Error: "+e?.message);}};

/* == CREDIT HISTORY == */
async function openCreditHist(id){const a=ST.creditAccounts.find(x=>x.id===id);if(!a)return;ST.creditHistId=id;g("creditHistTitle").textContent=a.name+" | Saldo: "+fmtMoney(a.balance,a.currency||ST.currency);await renderCreditHist();g("creditHistModal").classList.add("show");}
async function renderCreditHist(){if(!ST.creditHistId)return;try{const pays=await listCreditPaysByAccount(ST.creditHistId),total=pays.reduce((s,p)=>s+Number(p.amount_paid||0),0);g("creditHistTotal").textContent=fmtMoney(total,ST.currency);g("creditHistCount").textContent=String(pays.length);const tb=g("creditHistBody");tb.innerHTML="";pays.forEach(p=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="mono">${esc(p.pay_date)}</td><td class="mono">${fmtMoney(p.amount_paid,ST.currency)}</td><td class="mono">${fmtMoney(p.balance_after,ST.currency)}</td><td>${esc(p.note||"")}</td><td><button class="btn-danger" style="font-size:12px;padding:4px 9px" data-dp="${p.id}">X</button></td>`;tb.appendChild(tr);});tb.querySelectorAll("[data-dp]").forEach(btn=>btn.onclick=async()=>{if(!confirm("Borrar este pago?"))return;try{await deleteCreditPayment(btn.dataset.dp);toast("Borrado");await renderCreditHist();}catch(e){toast("Error: "+e?.message);}});}catch(e){toast("Error: "+e?.message);}}
g("btnCreditHistClose").onclick=()=>{ST.creditHistId=null;g("creditHistModal").classList.remove("show");};
g("creditHistModal").onclick=e=>{if(e.target===g("creditHistModal")){ST.creditHistId=null;g("creditHistModal").classList.remove("show");}};

/* == BILL NAME MODAL == */
["btnAddBillName","btnPayAddBill"].forEach(id=>g(id)&&(g(id).onclick=()=>{g("billNameNew").value="";g("billNameHint").textContent="--";g("billNameModal").classList.add("show");setTimeout(()=>g("billNameNew").focus(),60);}));
g("btnBillNameClose").onclick=()=>g("billNameModal").classList.remove("show");
g("billNameModal").onclick=e=>{if(e.target===g("billNameModal"))g("billNameModal").classList.remove("show");};
g("btnBillNameSave").onclick=async()=>{const n=(g("billNameNew").value||"").trim();if(!n){g("billNameHint").textContent="Escribe un nombre.";return;}await setNameLib([...await getNameLib(),n]);await rebuildBillCombo(n);g("billNameHint").textContent="Guardado";toast("Nombre agregado");g("billNameModal").classList.remove("show");};

/* == SUPABASE MODAL == */
window.openSupaModal=()=>{const c=loadCreds();g("sbUrl").value=c.url||"";g("sbKey").value=c.key||"";updSbPrev();updSbConn("chk","Sin verificar");g("sbTestResult").style.display="none";g("supaModal").classList.add("show");};
window.closeSupaModal=()=>g("supaModal").classList.remove("show");
g("supaModal").onclick=e=>{if(e.target===g("supaModal"))closeSupaModal();};
function updSbPrev(){const url=g("sbUrl").value.trim(),key=g("sbKey").value.trim();g("sbUrlPreview").textContent=url||"--";g("sbKeyPreview").textContent=key.length>20?key.slice(0,20)+"........"+key.slice(-8):(key||"--");g("anonKeyTag").innerHTML=key?(isJWT(key)?'<span style="color:var(--ok);font-size:11px">Valido</span>':'<span style="color:var(--danger);font-size:11px">Invalido (debe empezar con eyJ)</span>'):"";g("sbUrl").className=url?(isURL(url)?"valid":"invalid"):"";g("sbKey").className=key?(isJWT(key)?"valid":"invalid"):"";}
function updSbConn(state,text){const el=g("supaConnBox"),cls={ok:"ok-c",err:"err-c",chk:"chk-c"}[state]||"chk-c";el.className="conn-status-box "+cls;g("supaConnText").textContent=text;}
g("sbUrl").oninput=g("sbKey").oninput=updSbPrev;
g("btnSbSave").onclick=async()=>{const url=g("sbUrl").value.trim(),key=g("sbKey").value.trim();if(!url||!isURL(url))return toast("URL invalida");if(!key||!isJWT(key))return toast("Anon Key invalida (debe empezar con eyJ)");saveCreds(url,key);sb=await loadSB(url,key);window.sb=sb;toast("Credenciales guardadas");updSbPrev();await updateConnBadge();};
g("btnSbTest").onclick=async()=>{const url=g("sbUrl").value.trim(),key=g("sbKey").value.trim();if(!url||!key)return toast("Guarda las credenciales primero");updSbConn("chk","Probando...");const res=g("sbTestResult");res.style.display="block";res.style.cssText="display:block;margin-top:12px;padding:12px;border-radius:10px;font-family:var(--mono);font-size:13px;background:rgba(255,184,48,.06);border:1px solid rgba(255,184,48,.25);color:#ffb830";res.textContent="Conectando...";try{const tc=await loadSB(url,key);if(!tc)throw new Error("No se creo el cliente");const{error:e1}=await tc.from("bills").select("id").limit(1);if(e1){const{error:e2}=await tc.from("credit_accounts").select("id").limit(1);if(e2)throw e2;}updSbConn("ok","Conexion exitosa");res.style.background="rgba(0,212,168,.06)";res.style.borderColor="rgba(0,212,168,.3)";res.style.color="var(--ok)";res.textContent="Conexion exitosa. Supabase responde correctamente.";await updateConnBadge();}catch(e){updSbConn("err","Error de conexion");res.style.background="rgba(255,64,96,.06)";res.style.borderColor="rgba(255,64,96,.3)";res.style.color="var(--danger)";const msg=e?.message||String(e);let hint="";if(msg.includes("apikey")||msg.includes("Invalid API"))hint="\n\nLa Anon Key es invalida. Ve a Settings > API y copia la clave anon (empieza con eyJ).";else if(msg.includes("relation")||msg.includes("exist"))hint="\n\nConexion OK pero falta una tabla. Ejecuta el SQL de creacion en tu dashboard.";else if(msg.includes("fetch")||msg.includes("network"))hint="\n\nError de red. Verifica la URL del proyecto.";res.textContent="Error: "+msg+hint;}};
g("btnSbClear").onclick=()=>{if(!confirm("Borrar credenciales?"))return;clearCreds();sb=null;window.sb=null;g("sbUrl").value="";g("sbKey").value="";updSbPrev();updSbConn("chk","Sin credenciales");g("sbTestResult").style.display="none";updateConnBadge();toast("Credenciales borradas");};

/* == REPORTS == */
function getPeriodRange(p){const n=new Date(),y=n.getFullYear(),m=n.getMonth();if(p==="thismonth")return[toISO(new Date(y,m,1)),toISO(new Date(y,m+1,0))];if(p==="lastmonth")return[toISO(new Date(y,m-1,1)),toISO(new Date(y,m,0))];if(p==="last3")return[toISO(new Date(y,m-2,1)),toISO(new Date(y,m+1,0))];if(p==="last6")return[toISO(new Date(y,m-5,1)),toISO(new Date(y,m+1,0))];if(p==="year")return[y+"-01-01",y+"-12-31"];return["2000-01-01","2099-12-31"];}
async function generateReport(){const period=g("reportPeriod").value,[from,to]=getPeriodRange(period);g("rBillsPeriodLabel").textContent=from+" - "+to;g("rCreditPeriodLabel").textContent=from+" - "+to;try{const bp=(await allPayments()).filter(p=>p.pay_date>=from&&p.pay_date<=to).sort((a,b)=>a.pay_date>b.pay_date?-1:1),cp=(await allCreditPayments()).filter(p=>p.pay_date>=from&&p.pay_date<=to).sort((a,b)=>a.pay_date>b.pay_date?-1:1);const tb=bp.reduce((s,p)=>s+Number(p.amount_paid||0),0),tc=cp.reduce((s,p)=>s+Number(p.amount_paid||0),0),td=ST.creditAccounts.reduce((s,a)=>s+Number(a.balance||0),0);g("rTotalBills").textContent=fmtMoney(tb,ST.currency);g("rBillsCount").textContent=bp.length+" pagos";g("rTotalCredit").textContent=fmtMoney(tc,ST.currency);g("rCreditCount").textContent=cp.length+" pagos";g("rGrandTotal").textContent=fmtMoney(tb+tc,ST.currency);g("rCreditDebt").textContent=fmtMoney(td,ST.currency);const tbb=g("rBillsBody");tbb.innerHTML="";bp.forEach(p=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="mono">${esc(p.pay_date)}</td><td>${esc(p.bill_name||"")}</td><td class="mono">${fmtMoney(p.amount_paid,ST.currency)}</td><td>${esc(p.note||"")}</td>`;tbb.appendChild(tr);});if(!bp.length)tbb.innerHTML=`<tr><td colspan="4" class="text-muted" style="padding:12px">Sin pagos en este periodo.</td></tr>`;const tcb=g("rCreditBody");tcb.innerHTML="";cp.forEach(p=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="mono">${esc(p.pay_date)}</td><td>${esc(p.account_name||"")}</td><td class="mono text-ok">${fmtMoney(p.amount_paid,ST.currency)}</td><td class="mono">${fmtMoney(p.balance_after,ST.currency)}</td>`;tcb.appendChild(tr);});if(!cp.length)tcb.innerHTML=`<tr><td colspan="4" class="text-muted" style="padding:12px">Sin pagos en este periodo.</td></tr>`;window._rdata={bp,cp,from,to};toast("Reporte generado");}catch(e){toast("Error: "+e?.message);}}
g("btnGenerateReport").onclick=generateReport;g("reportPeriod").onchange=generateReport;
g("btnExportCSV").onclick=()=>{const d=window._rdata;if(!d)return toast("Genera el reporte primero");const rows=["tipo,fecha,concepto,monto,nota"];d.bp.forEach(p=>rows.push(["bill",p.pay_date,`"${(p.bill_name||"").replaceAll('"','""')}"`,p.amount_paid,`"${(p.note||"").replaceAll('"','""')}"`].join(",")));d.cp.forEach(p=>rows.push(["credito",p.pay_date,`"${(p.account_name||"").replaceAll('"','""')}"`,p.amount_paid,`"${(p.note||"").replaceAll('"','""')}"`].join(",")));dlFile(`reporte_${d.from}_${d.to}.csv`,rows.join("\n"),"text/csv");toast("CSV exportado");};

/* == TABS == */
function switchTab(id){document.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active"));document.querySelectorAll(".nav-tab").forEach(b=>b.classList.remove("active"));g(id)?.classList.add("active");document.querySelector(`.nav-tab[data-tab="${id}"]`)?.classList.add("active");}
window.switchTab=switchTab;
document.querySelectorAll(".nav-tab").forEach(btn=>btn.onclick=()=>switchTab(btn.dataset.tab));

/* == MISC == */
function dlFile(name,content,mime="application/octet-stream"){const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(new Blob([content],{type:mime})),download:name});document.body.appendChild(a);a.click();a.remove();}
g("remindDays").onchange=async()=>{await setSetting("remindDays",Number(g("remindDays").value));await refresh();};
g("filter").onchange=renderBillsTable;g("search").oninput=renderBillsTable;
g("btnRefresh").onclick=()=>refresh().then(()=>toast("Actualizado")).catch(e=>toast("Error: "+e?.message));
g("btnCreditRefresh").onclick=()=>refresh().then(()=>toast("Actualizado")).catch(e=>toast("Error: "+e?.message));
g("btnReset").onclick=async()=>{if(!confirm("Borrar TODA la DB local?"))return;await wipeDB();toast("DB local borrada");location.reload();};

/* == NOTIFICATIONS == */
const NOTIF_KEY = 'fc_notif_sent'; // localStorage: {billId_YYYY-MM-DD: true}

function notifSentKey(billId, date){ return `${billId}_${date}`; }
function wasNotified(billId, date){ 
  try { return !!JSON.parse(localStorage.getItem(NOTIF_KEY)||'{}')[notifSentKey(billId,date)]; } 
  catch { return false; } 
}
function markNotified(billId, date){
  try {
    const map = JSON.parse(localStorage.getItem(NOTIF_KEY)||'{}');
    map[notifSentKey(billId,date)] = true;
    // Keep only last 200 entries to avoid bloat
    const keys = Object.keys(map);
    if(keys.length > 200) keys.slice(0, keys.length - 200).forEach(k => delete map[k]);
    localStorage.setItem(NOTIF_KEY, JSON.stringify(map));
  } catch {}
}

async function requestNotifPermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted') return true;
  if(Notification.permission === 'denied') return false;
  const result = await Notification.requestPermission();
  return result === 'granted';
}

function sendNotif(title, body, tag){
  if(!('Notification' in window) || Notification.permission !== 'granted') return;
  try {
    const n = new Notification(title, {
      body,
      tag,
      icon: './icon-192.png',
      badge: './icon-192.png',
      requireInteraction: true
    });
    n.onclick = () => { window.focus(); n.close(); };
  } catch {}
}

async function checkBillNotifications(){
  if(!('Notification' in window) || Notification.permission !== 'granted') return;
  const today = todayISO();
  const bills = ST.bills || [];

  bills.forEach(b => {
    if(!b.next_due_date || !b.name) return;
    const daysLeft = daysBetween(today, b.next_due_date);
    const tag = `fc_bill_${b.id}`;

    // Overdue: past due and not yet paid this cycle
    if(daysLeft < 0){
      const notifId = `${b.id}_overdue_${b.next_due_date}`;
      if(!wasNotified(notifId, today)){
        sendNotif(
          `丘멆잺 Bill vencido: ${b.name}`,
          `Venci칩 el ${b.next_due_date} 췅 ${fmtMoney(b.amount_monthly, ST.currency)} 췅 ${Math.abs(daysLeft)} d칤a${Math.abs(daysLeft)!==1?'s':''} de retraso`,
          tag
        );
        markNotified(notifId, today);
      }
    }
    // Due today
    else if(daysLeft === 0){
      const notifId = `${b.id}_today_${b.next_due_date}`;
      if(!wasNotified(notifId, today)){
        sendNotif(
          `游댒 Bill vence HOY: ${b.name}`,
          `Monto: ${fmtMoney(b.amount_monthly, ST.currency)}${b.vendor ? ' 췅 ' + b.vendor : ''}`,
          tag
        );
        markNotified(notifId, today);
      }
    }
    // Due soon (within remindDays)
    else if(daysLeft > 0 && daysLeft <= ST.remindDays){
      const notifId = `${b.id}_soon_${b.next_due_date}`;
      if(!wasNotified(notifId, today)){
        sendNotif(
          `游늰 Bill pr칩ximo: ${b.name}`,
          `Vence en ${daysLeft} d칤a${daysLeft!==1?'s':''} (${b.next_due_date}) 췅 ${fmtMoney(b.amount_monthly, ST.currency)}`,
          tag
        );
        markNotified(notifId, today);
      }
    }
  });
}

async function initNotifications(){
  if(!('Notification' in window)) return;
  // Show permission button in topbar if not yet decided
  if(Notification.permission === 'default'){
    const btn = document.createElement('button');
    btn.id = 'btnEnableNotif';
    btn.className = 'btn-warn';
    btn.style.fontSize = '12px';
    btn.title = 'Activar notificaciones de vencimientos';
    btn.innerHTML = '游댒 Activar alertas';
    btn.onclick = async () => {
      const granted = await requestNotifPermission();
      if(granted){ 
        btn.remove(); 
        toast('九 Notificaciones activadas');
        await checkBillNotifications();
      } else {
        toast('仇 Permiso denegado');
      }
    };
    const actions = document.querySelector('.topbar-actions');
    if(actions) actions.prepend(btn);
  } else if(Notification.permission === 'granted'){
    await checkBillNotifications();
  }
}

/* == BOOT == */
(async()=>{
  const cur=await getSetting("currency",null);if(!cur)await setSetting("currency","USD");
  const rd=await getSetting("remindDays",null);if(rd===null)await setSetting("remindDays",7);
  const lib=await getSetting("billNameLib",null);if(!Array.isArray(lib))await setSetting("billNameLib",[]);
  buildDays("dueDay");buildDays("ccCutDay");buildDays("ccPayDay");
  await initSB();
  await refresh();
  await generateReport();
  await initNotifications();
  // Re-check notifications every 60 minutes
  setInterval(checkBillNotifications, 60 * 60 * 1000);
  setInterval(updateConnBadge,30000);
})();
</script>
</body>
</html>